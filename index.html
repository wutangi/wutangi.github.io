<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã€å—¨äº‘å°ã€‘åœ¨çº¿ä¸‹å•ä¸ä»·æ ¼è®¡ç®—</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .price-table th, .price-table td { padding: 8px 12px; text-align: left; }
        select:disabled, button:disabled { background-color: #e9ecef; opacity: 0.7; cursor: not-allowed; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        .logo-img { max-height: 80px; margin-bottom: 1rem; }
        .modal-overlay { position: fixed; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 90vw; display: flex; flex-direction: column; }
        .pdf-preview-modal-content { max-height: 90vh; overflow: hidden; }
        .qr-payment-modal-content { max-width: 400px; text-align: center; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .pdf-preview-canvas-container { flex-grow: 1; overflow-y: auto; border: 1px solid #ccc; background-color: #f9f9f9; }
        .pdf-preview-canvas-container canvas { max-width: 100%; height: auto; display: block; margin: 0 auto 10px auto; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .segment-item input.invalid-segment, .segment-item select.invalid-segment { border-color: red !important; }
        .detailed-cost-row td { padding-top: 2px; padding-bottom: 2px; font-size: 0.8rem; color: #4A5568; }
        .payment-buttons-container { margin-top: 1rem; display: flex; gap: 0.5rem; }
        .payment-buttons-container button { flex-grow: 1; }
        .qr-code-image { 
            max-width: 250px; 
            max-height: 250px;
            width: auto;
            height: auto;
            margin: 1rem auto; 
            border: 1px solid #ddd; 
        }
        .file-item { transition: background-color 0.2s ease-in-out; }
        .file-item.active-file { background-color: #ebf8ff; border-left: 4px solid #3b82f6; }
        .action-buttons-container button, .payment-buttons-container button { margin-bottom: 0.5rem; }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-4xl">
        <header class="mb-8 text-center">
            <img src="https://i.postimg.cc/X7ywMj8b/16661747226997-pic-hd.jpg" alt="å—¨äº‘å° Logo" id="siteLogo" class="logo-img mx-auto">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">ã€å—¨äº‘å°ã€‘åœ¨çº¿ä¸‹å•ä¸ä»·æ ¼è®¡ç®—</h1>
            <p class="text-gray-600 mt-2">ç”±åœ¨æ ¡å­¦é•¿/å­¦å§ç”¨å¿ƒç»è¥ï¼Œä¸ºæ‚¨æä¾›ä¾¿æ·ã€å®æƒ ã€ä¼˜è´¨çš„æ‰“å°æœåŠ¡ï¼</p>
        </header>

        <section id="fileUploadSection" class="mb-8 p-6 bg-white rounded-xl shadow-lg">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">1. ä¸Šä¼ æ–‡ä»¶</h2>
            <div class="mb-4">
                <label for="fileUpload" class="block text-sm font-medium text-gray-700 mb-1">é€‰æ‹©æ–‡ä»¶ (å¯å¤šé€‰, æ¨èPDF)</label>
                <input type="file" id="fileUpload" name="fileUpload" accept="application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,.ppt,.pptx" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 transition-colors" multiple>
                <p id="fileUploadStatus" class="mt-1 text-xs text-gray-500">PDFæ ¼å¼å¯è‡ªåŠ¨è®¡ç®—é¡µæ•°å¹¶æ”¯æŒé¢„è§ˆã€‚Wordç­‰å…¶ä»–æ ¼å¼è¯·æ‰‹åŠ¨è¾“å…¥é¡µæ•°ã€‚æ¨èè½¬æ¢ä¸ºPDFåä¸Šä¼ ã€‚</p>
            </div>
        </section>

        <section id="fileManagementSection" class="mb-8 p-6 bg-white rounded-xl shadow-lg">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">å·²ä¸Šä¼ æ–‡ä»¶åˆ—è¡¨</h2>
            <div id="fileListContainer" class="space-y-3">
                </div>
            <p id="noFilesMessage" class="text-gray-500 text-sm">æš‚æ— å·²ä¸Šä¼ æ–‡ä»¶ã€‚è¯·ç‚¹å‡»ä¸Šæ–¹é€‰æ‹©æ–‡ä»¶ã€‚</p>
        </section>
        
        <div id="activeFileConfigurationSection" class="hidden">
            <section class="mb-8 p-6 bg-blue-50 rounded-xl shadow-lg border border-blue-200">
                <h2 class="text-2xl font-semibold text-gray-700 mb-1">å½“å‰æ–‡ä»¶: <span id="activeFileName" class="text-blue-600">æ— </span></h2>
                <p class="text-xs text-gray-500 mb-4">ä»¥ä¸‹è®¾ç½®å°†åº”ç”¨äºä¸Šæ–¹é«˜äº®æ˜¾ç¤ºçš„æ–‡ä»¶ã€‚</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                    <div>
                        <label for="activeFileTotalPages" class="block text-sm font-medium text-gray-700 mb-1">è¯¥æ–‡ä»¶æ€»é¡µæ•°</label>
                        <input type="number" id="activeFileTotalPages" value="1" min="1" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        <p class="mt-1 text-xs text-gray-500">PDFæ–‡ä»¶å°†è‡ªåŠ¨è®¡ç®—ã€‚å…¶ä»–æ ¼å¼è¯·åŠ¡å¿…æ‰‹åŠ¨å¡«å†™å‡†ç¡®é¡µæ•°ã€‚</p>
                    </div>
                    <div>
                        <label for="activeFileQuantity" class="block text-sm font-medium text-gray-700 mb-1">è¯¥æ–‡ä»¶æ‰“å°ä»½æ•°</label>
                        <input type="number" id="activeFileQuantity" value="1" min="1" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                </div>
            </section>

            <section id="printingOptionsSection" class="mb-8 p-6 bg-white rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">æ‰“å°é€‰é¡¹ (é’ˆå¯¹å½“å‰æ–‡ä»¶)</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="paperCategory" class="block text-sm font-medium text-gray-700 mb-1">çº¸å¼ ç±»åˆ«</label>
                        <select id="paperCategory" name="paperCategory" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            <option value="basic">æ™®é€šæ•°ç æ‰“å°çº¸ (é»‘ç™½)</option>
                            <option value="colorJet">å½©æ¿€çº¸ (å½©è‰²)</option>
                            <option value="coated">é“œç‰ˆçº¸ (å½©è‰²)</option>
                        </select>
                    </div>
                    <div>
                        <label for="paperSize" class="block text-sm font-medium text-gray-700 mb-1">çº¸å¼ è§„æ ¼</label>
                        <select id="paperSize" name="paperSize" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        </select>
                    </div>
                    <div id="coatedPaperWeightGroup" class="hidden">
                        <label for="coatedPaperWeight" class="block text-sm font-medium text-gray-700 mb-1">é“œç‰ˆçº¸å…‹é‡ (A4)</label>
                        <select id="coatedPaperWeight" name="coatedPaperWeight" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            <option value="128g">128g</option>
                            <option value="157g">157g</option>
                            <option value="200g">200g</option>
                            <option value="250g">250g</option>
                            <option value="300g">300g</option>
                        </select>
                    </div>
                     <div>
                        <label for="activeFileBindingType" class="block text-sm font-medium text-gray-700 mb-1">è¯¥æ–‡ä»¶è£…è®¢æœåŠ¡ (å¯é€‰)</label>
                        <select id="activeFileBindingType" name="activeFileBindingType" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            <option value="none">æ— è£…è®¢ (0.00 å…ƒ)</option>
                            <optgroup label="èƒ¶è£…ç±» (ç‰¹æƒ )">
                                <option value="coatedNoFilm" data-note="å«æŒ‡å®šå°é¢">é“œç‰ˆçº¸èƒ¶è£… (ä¸è¦†è†œ) (7.00 å…ƒ)</option>
                                <option value="coatedFilm" data-note="å«æŒ‡å®šå°é¢">é“œç‰ˆçº¸èƒ¶è£… (è¦†è†œ) (8.00 å…ƒ)</option>
                                <option value="texturedNoText" data-note="å«æŒ‡å®šå°é¢">çš®çº¹çº¸èƒ¶è£… (ä¸å°å­—) (4.00 å…ƒ)</option>
                                <option value="texturedText" data-note="å«æŒ‡å®šå°é¢">çš®çº¹çº¸èƒ¶è£… (å°å­—) (5.00 å…ƒ)</option>
                                <option value="kraftNoText" data-note="å«æŒ‡å®šå°é¢">ç‰›çš®çº¸èƒ¶è£… (ä¸å°å­—) (4.00 å…ƒ)</option>
                                <option value="kraftText" data-note="å«æŒ‡å®šå°é¢">ç‰›çš®çº¸èƒ¶è£… (å°å­—) (5.00 å…ƒ)</option>
                            </optgroup>
                            <optgroup label="å…¶ä»–è£…è®¢åŠç²¾è£…ç±» ">
                                <option value="staple" data-note="æ— å°é¢ (å°é¢å¦è®¡)">è®¢ä¹¦é’ˆè£…è®¢ (0.40 å…ƒ)</option>
                                <option value="saddleStitch" data-note="ä¸å«æ‰“å°å°é¢ (å°é¢å¦è®¡)ï¼Œæœ‰Pæ•°å’Œå€æ•°é™åˆ¶">éª‘é©¬é’‰è£…è®¢ (4.00 å…ƒ)</option>
                                <option value="wireO" data-note="å¸¦é€æ˜èƒ¶ç‰‡ï¼Œä¸å«æ‰“å°å°é¢ (å°é¢å¦è®¡)">é“åœˆè£…è®¢ (10.00 å…ƒ)</option>
                                <option value="looseLeaf" data-note="å¸¦é€æ˜èƒ¶ç‰‡">æ´»é¡µå¤¹è£…è®¢ (10.00 å…ƒ)</option>
                                <option value="hardCover" data-note="é«˜ç«¯ç²¾è£…ï¼Œä¸å«å†…é¡µæ‰“å°è´¹">ç¡¬å£³ç²¾è£… (140.00 å…ƒ)</option>
                                <option value="butterfly" data-note="é«˜ç«¯ç²¾è£…ï¼Œä¸å«å†…é¡µæ‰“å°è´¹">è´è¶ç²¾è£… (180.00 å…ƒ)</option>
                            </optgroup>
                        </select>
                        <p id="activeFileBindingNote" class="mt-1 text-xs text-gray-500"></p>
                    </div>
                </div>
    
                <div id="printSegmentsSection" class="mt-6 p-4 border border-gray-200 rounded-lg shadow">
                    <h3 class="text-xl font-semibold text-gray-800 mb-3">åˆ†æ®µæ‰“å°è®¾ç½® (é’ˆå¯¹å½“å‰æ–‡ä»¶)</h3>
                    <div id="segmentListContainer" class="space-y-4 mb-4">
                        </div>
                    <button id="addSegmentBtn" type="button" class="px-4 py-2 text-sm bg-green-500 hover:bg-green-600 text-white rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                        æ·»åŠ æ‰“å°åŒºé—´
                    </button>
                    <p class="text-xs text-gray-500 mt-3">
                        è¯·ç¡®ä¿æ‰€æœ‰é¡µç åŒºé—´ä¸é‡å ï¼Œå¹¶è¦†ç›–æ‰€æœ‰éœ€è¦æ‰“å°çš„é¡µé¢ã€‚æ€»é¡µæ•°å‚è€ƒä¸Šæ–¹è¯¥æ–‡ä»¶çš„æ€»é¡µæ•°ã€‚
                    </p>
                </div>
            </section>
        </div>

        <section id="priceSummarySection" class="mb-8 p-6 bg-gray-50 rounded-xl shadow-lg sticky top-4">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">ä»·æ ¼æ€»è§ˆ</h2>
            <table class="w-full price-table text-sm text-gray-700">
                <tbody id="detailedPrintCostsBody">
                    </tbody>
                <tbody> <tr id="basePrintCostRow"> <td id="summaryBasePrintCostLabel">æ€»æ‰“å°è´¹ç”¨:</td>
                        <td id="summaryBasePrintCost" class="text-right font-medium">0.00 å…ƒ</td>
                    </tr>
                    <tr>
                        <td>æ€»è£…è®¢è´¹ç”¨:</td>
                        <td id="summaryBindingCost" class="text-right font-medium">0.00 å…ƒ</td>
                    </tr>
                    <tr id="minOrderAdjustmentRow" class="hidden"> 
                        <td id="minOrderAdjustmentLabel">æœ€ä½èµ·å°:</td> 
                        <td id="summaryMinOrderAdjustment" class="text-right font-medium">0.00 å…ƒ</td>
                    </tr>
                    <tr> 
                        <td>è¿è´¹:</td>
                        <td id="summaryShippingCost" class="text-right font-medium">0.00 å…ƒ</td>
                    </tr>
                    <tr class="border-t-2 border-gray-300">
                        <td class="text-lg font-semibold">é¢„ä¼°æ€»ä»·:</td>
                        <td id="summaryTotalCost" class="text-right text-lg font-semibold text-indigo-600">0.00 å…ƒ</td>
                    </tr>
                </tbody>
            </table>
            <div class="mt-4 text-xs text-gray-500">
                <p>æœ€ä½èµ·å°ï¼šæœ¬åº—æ‰“å°åŠç›¸å…³æœåŠ¡ï¼ˆä¸å«é‚®è´¹éƒ¨åˆ†ï¼‰æœ€ä½èµ·å°ä¸º 5.00å…ƒã€‚</p>
                <p>åŒ…é‚®æ”¿ç­–ï¼šè®¢å•æ€»é‡‘é¢ (å«æ‰€æœ‰æ‰“å°ã€è£…è®¢ç­‰è´¹ç”¨) æ»¡ 25.00 å…ƒåŒ…é‚®ã€‚</p>
                <p>é‚®è´¹æ ‡å‡†ï¼šè®¢å•æ€»é‡‘é¢ä¸è¶³25.00å…ƒåŒ…é‚®é—¨æ§›çš„ï¼Œç»Ÿä¸€æ”¶å– 6.00å…ƒ è¿è´¹ã€‚</p>
            </div>
            <div class="action-buttons-container mt-6">
                 <button id="submitOrder" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:shadow-lg transition-all duration-150 ease-in-out">
                    å¯¼å‡ºè®¢å•ä¿¡æ¯
                </button>
                </div>
            <div class="payment-buttons-container"> <button id="alipayBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors">
                    æ”¯ä»˜å®æ”¯ä»˜ 
                </button>
                <button id="qrPayBtn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-colors">
                    æ‰«ç æ”¯ä»˜ 
                </button>
            </div>
        </section>

        <section id="infoSection" class="p-6 bg-white rounded-xl shadow-lg">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">å…¶ä»–è¯´æ˜ä¸æ¸©é¦¨æç¤º</h2>
            <ul class="list-disc list-inside space-y-2 text-sm text-gray-600">
                <li><strong>æ— ç‰ŒåŒ…è£…ï¼š</strong> æ‰€æœ‰è®¢å•å‡é‡‡ç”¨æ— å“ç‰Œæ ‡è¯†çš„åŒ…è£…å‘è´§ï¼Œä¿æŠ¤æ‚¨çš„éšç§ã€‚</li>
                <li><strong>ä¸‹å•æµç¨‹ï¼š</strong> æ­¤ç½‘é¡µå¯è¾…åŠ©æ‚¨ä¼°ç®—ä»·æ ¼å¹¶ç”Ÿæˆè®¢å•è®°å½• (CSVæ–‡ä»¶)ã€‚è¯·é€šè¿‡å¾®ä¿¡ç§èŠå‘é€åŸå§‹æ‰“å°æ–‡ä»¶ã€å¯¼å‡ºçš„è®¢å•CSVæ–‡ä»¶ä»¥åŠè¯¦ç»†æ‰“å°è¦æ±‚ï¼ˆå¦‚æ”¶è´§ä¿¡æ¯ç­‰ï¼‰ï¼Œæˆ‘ä»¬å°†å°½å¿«ä¸æ‚¨ç¡®è®¤è®¢å•è¯¦æƒ…å’Œæ€»é‡‘é¢ã€‚</li>
                <li><strong>æ–‡ä»¶æ ¼å¼ï¼š</strong> æ¨èä½¿ç”¨PDFæ ¼å¼ä»¥ç¡®ä¿æ‰“å°æ•ˆæœã€é¡µæ•°è‡ªåŠ¨è®¡ç®—å’Œå†…å®¹é¢„è§ˆã€‚å…¶ä»–æ ¼å¼ï¼ˆå¦‚Word, PPTï¼‰è¯·æå‰å’¨è¯¢ï¼Œå¯èƒ½éœ€è¦è½¬æ¢ä¸ºPDFï¼Œå¹¶è¯·æ‰‹åŠ¨è¾“å…¥é¡µæ•°ã€‚</li>
                <li><strong>å…³äºæˆ‘ä»¬ï¼š</strong> â€œå—¨äº‘å°â€ç”±åœ¨æ ¡å­¦é•¿/å­¦å§ç”¨å¿ƒç»è¥ï¼Œè‡´åŠ›äºä¸ºåŒå­¦ä»¬æä¾›ä¾¿æ·ã€å®æƒ ã€ä¼˜è´¨çš„æ‰“å°æœåŠ¡ï¼ğŸ˜Š</li>
                <li><strong>ä»·æ ¼ç¡®è®¤ï¼š</strong> å¦‚æœ‰ç‰¹æ®Šæ‰“å°éœ€æ±‚æˆ–å¯¹ä»·æ ¼æœ‰ç–‘é—®ï¼Œè¯·éšæ—¶ä¸æˆ‘ä»¬æ²Ÿé€šç¡®è®¤ã€‚æ­¤è®¡ç®—å™¨ä»·æ ¼ä¸ºå‚è€ƒï¼Œæœ€ç»ˆä»·æ ¼ä»¥å®¢æœç¡®è®¤ä¸ºå‡†ã€‚</li>
                <li><strong>éª‘é©¬é’‰å¤‡æ³¨ï¼š</strong> è‹¥é€‰æ‹©éª‘é©¬é’‰è£…è®¢ï¼Œè¯·ç¡®ä¿æ–‡æ¡£é¡µæ•° (Pæ•°) ä¸º4çš„å€æ•°ï¼Œä¸”æ€»é¡µæ•°åœ¨40Pï¼ˆå³10å¼ çº¸ï¼‰ä»¥ä¸‹ã€‚</li>
            </ul>
        </section>

        <footer class="mt-12 text-center text-sm text-gray-500">
            <p>&copy; 2024-2025 ã€å—¨äº‘å°ã€‘ç‰ˆæƒæ‰€æœ‰</p>
        </footer>
    </div>

    <div id="pdfPreviewModal" class="modal-overlay hidden">
        <div class="modal-content pdf-preview-modal-content">
            <div class="modal-header pdf-preview-header">
                <h3 class="text-xl font-semibold">PDF é¢„è§ˆ</h3>
                <span id="previewPageInfo" class="text-sm text-gray-600"></span> 
                <button id="closePreviewModalBtn" class="text-gray-700 hover:text-red-500 text-2xl">&times;</button>
            </div>
            <div id="pdfPreviewCanvasContainer" class="pdf-preview-canvas-container">
            </div>
        </div>
    </div>

    <div id="qrPaymentModal" class="modal-overlay hidden">
        <div class="modal-content qr-payment-modal-content">
            <div class="modal-header">
                <h3 class="text-xl font-semibold">å¾®ä¿¡æ‰«ç æ”¯ä»˜</h3>
                <button id="closeQrModalBtn" class="text-gray-700 hover:text-red-500 text-2xl">&times;</button>
            </div>
            <img id="qrCodeImg" src="https://i.postimg.cc/nhtXjSRD/51747244584-pic.jpg" alt="å¾®ä¿¡ä»˜æ¬¾äºŒç»´ç " class="qr-code-image">
            <p class="text-lg font-semibold mb-2">è¯·ä½¿ç”¨å¾®ä¿¡æ‰«æä¸Šæ–¹äºŒç»´ç å®Œæˆæ”¯ä»˜</p>
            <p class="text-2xl font-bold text-red-600 mb-4" id="qrPaymentAmount">é‡‘é¢: 0.00 å…ƒ</p>
            <p class="text-xs text-gray-500"></p>
        </div>
    </div>

    <div id="alipayQrPaymentModal" class="modal-overlay hidden">
        <div class="modal-content qr-payment-modal-content">
            <div class="modal-header">
                <h3 class="text-xl font-semibold">æ”¯ä»˜å®æ‰«ç æ”¯ä»˜</h3>
                <button id="closeAlipayQrModalBtn" class="text-gray-700 hover:text-red-500 text-2xl">&times;</button>
            </div>
            <img id="alipayQrCodeImg" src="https://i.postimg.cc/SxGcRxhs/16691747296161-pic-hd.jpg" alt="æ”¯ä»˜å®ä»˜æ¬¾äºŒç»´ç " class="qr-code-image">
            <p class="text-lg font-semibold mb-2">è¯·ä½¿ç”¨æ”¯ä»˜å®æ‰«æä¸Šæ–¹äºŒç»´ç å®Œæˆæ”¯ä»˜</p>
            <p class="text-2xl font-bold text-blue-600 mb-4" id="alipayQrPaymentAmount">é‡‘é¢: 0.00 å…ƒ</p>
            <p class="text-xs text-gray-500"></p>
        </div>
    </div>


    <script>
        const pricing = { // ... (pricing object as provided) ...
            basicPrint: { 
                a7: { single: 0.03, double: 0.03 }, 
                a4: { single: 0.18, double: 0.125 },
                b5: { single: 0.15, double: 0.115 },
                a3: { single: 0.35, double: 0.25 }
            },
            colorPrintJet: { 
                a4: { single: 1.00, double: 0.75 },
                a3: { single: 2.00, double: 1.50 }
            },
            colorPrintCoated: { 
                '128g': { single: 1.50, double: 1.00 },
                '157g': { single: 2.00, double: 1.25 },
                '200g': { single: 2.25, double: 1.50 },
                '250g': { single: 2.50, double: 1.75 },
                '300g': { single: 3.00, double: 2.00 }
            },
            binding: { 
                none: 0, coatedNoFilm: 7.0, coatedFilm: 8.0, texturedNoText: 4.0, texturedText: 5.0,
                kraftNoText: 4.0, kraftText: 5.0, staple: 0.4, saddleStitch: 4.0, wireO: 10.0,
                looseLeaf: 10.0, hardCover: 140.0, butterfly: 180.0      
            },
            policies: { minOrderValue: 5.00, freeShippingThreshold: 25.00, shippingFee: 6.00 }
        };

        // ... (All const declarations for DOM elements remain the same) ...
        const fileUploadInput = document.getElementById('fileUpload');
        const fileUploadStatusP = document.getElementById('fileUploadStatus');
        const noFilesMessage = document.getElementById('noFilesMessage');
        const fileListContainer = document.getElementById('fileListContainer');
        const activeFileConfigurationSection = document.getElementById('activeFileConfigurationSection');
        const activeFileNameSpan = document.getElementById('activeFileName');
        const activeFileTotalPagesInput = document.getElementById('activeFileTotalPages');
        const activeFileQuantityInput = document.getElementById('activeFileQuantity'); 
        const activeFileBindingTypeSelect = document.getElementById('activeFileBindingType'); 
        const activeFileBindingNoteP = document.getElementById('activeFileBindingNote'); 
        
        const paperCategorySelect = document.getElementById('paperCategory');
        const paperSizeSelect = document.getElementById('paperSize');
        const coatedPaperWeightGroup = document.getElementById('coatedPaperWeightGroup');
        const coatedPaperWeightSelect = document.getElementById('coatedPaperWeight');
        
        const printPreviewBtn = document.getElementById('printPreviewBtn'); 
        const pdfPreviewModal = document.getElementById('pdfPreviewModal');
        const pdfPreviewCanvasContainer = document.getElementById('pdfPreviewCanvasContainer');
        const closePreviewModalBtn = document.getElementById('closePreviewModalBtn');
        const previewPageInfoSpan = document.getElementById('previewPageInfo');

        const segmentListContainer = document.getElementById('segmentListContainer'); 
        const addSegmentBtn = document.getElementById('addSegmentBtn'); 
        
        const detailedPrintCostsBody = document.getElementById('detailedPrintCostsBody'); 
        const summaryBasePrintCostLabel = document.getElementById('summaryBasePrintCostLabel'); 
        const summaryBasePrintCostEl = document.getElementById('summaryBasePrintCost');
        const summaryBindingCostEl = document.getElementById('summaryBindingCost');
        const minOrderAdjustmentRow = document.getElementById('minOrderAdjustmentRow'); 
        const summaryMinOrderAdjustmentEl = document.getElementById('summaryMinOrderAdjustment'); 
        const summaryShippingCostEl = document.getElementById('summaryShippingCost');
        const summaryTotalCostEl = document.getElementById('summaryTotalCost');
        const submitOrderButton = document.getElementById('submitOrder');
        // const sendToWeComBtn = document.getElementById('sendToWeComBtn'); // Removed
        const alipayBtn = document.getElementById('alipayBtn');
        const qrPayBtn = document.getElementById('qrPayBtn');
        const qrPaymentModal = document.getElementById('qrPaymentModal');
        const closeQrModalBtn = document.getElementById('closeQrModalBtn');
        const qrPaymentAmountEl = document.getElementById('qrPaymentAmount');

        const alipayQrPaymentModal = document.getElementById('alipayQrPaymentModal'); 
        const closeAlipayQrModalBtn = document.getElementById('closeAlipayQrModalBtn'); 
        const alipayQrPaymentAmountEl = document.getElementById('alipayQrPaymentAmount'); 

        const siteLogo = document.getElementById('siteLogo');

        let uploadedFilesData = []; 
        let activeFileId = null; 
        let globalFileIdCounter = 0;
        let filesProcessedCounter = 0; 
        let totalFilesToProcess = 0;   
        
        let currentPreviewPdfDoc = null; 
        let pdfPreviewScrollHandler = null; 

        function generateUniqueFileId() {
            globalFileIdCounter++;
            return `file-${globalFileIdCounter}-${Date.now()}`;
        }

        fileUploadInput.addEventListener('change', function(event) {
            const files = event.target.files;
            if (!files.length) return;

            totalFilesToProcess = files.length;
            filesProcessedCounter = 0;
            fileUploadStatusP.textContent = `å·²é€‰æ‹© ${files.length} ä¸ªæ–‡ä»¶ï¼Œæ­£åœ¨ä¸Šä¼  1/${totalFilesToProcess}...`;
            fileUploadStatusP.className = 'mt-1 text-xs text-blue-600';
            
            Array.from(files).forEach(file => {
                const fileId = generateUniqueFileId();
                const fileEntry = {
                    id: fileId,
                    fileObject: file,
                    fileName: file.name,
                    docTotalPages: 1, 
                    paperCategory: 'basic', 
                    paperSize: 'a4',    
                    coatedPaperWeight: '128g', 
                    quantity: 1,        
                    bindingType: 'none',
                    printSegments: [], 
                    segmentIdCounter: 0,
                    pdfDoc: null 
                };
                uploadedFilesData.push(fileEntry);
                processSingleFileEntry(fileEntry); 
            });
            fileUploadInput.value = ''; 
        });
        
        function checkAllFilesProcessed() {
            filesProcessedCounter++;
            if (filesProcessedCounter < totalFilesToProcess) {
                 fileUploadStatusP.textContent = `å·²é€‰æ‹© ${totalFilesToProcess} ä¸ªæ–‡ä»¶ï¼Œæ­£åœ¨ä¸Šä¼  ${filesProcessedCounter + 1}/${totalFilesToProcess}...`;
            } else if (filesProcessedCounter === totalFilesToProcess) {
                fileUploadStatusP.textContent = `${totalFilesToProcess} ä¸ªæ–‡ä»¶ä¸Šä¼ å®Œæˆã€‚`;
                fileUploadStatusP.className = 'mt-1 text-xs text-green-600';
                renderFileList();
                if (uploadedFilesData.length > 0 && !activeFileId) {
                    setActiveFile(uploadedFilesData[0].id); 
                }
                setTimeout(() => {
                    if (fileUploadStatusP.textContent === `${totalFilesToProcess} ä¸ªæ–‡ä»¶ä¸Šä¼ å®Œæˆã€‚`) { 
                         fileUploadStatusP.textContent = 'PDFæ ¼å¼å¯è‡ªåŠ¨è®¡ç®—é¡µæ•°å¹¶æ”¯æŒé¢„è§ˆã€‚Wordç­‰å…¶ä»–æ ¼å¼è¯·æ‰‹åŠ¨è¾“å…¥é¡µæ•°ã€‚æ¨èè½¬æ¢ä¸ºPDFåä¸Šä¼ ã€‚';
                         fileUploadStatusP.className = 'mt-1 text-xs text-gray-500';
                    }
                }, 5000);
            }
        }


        function processSingleFileEntry(fileEntry) {
            if (fileEntry.fileObject.type === "application/pdf") {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const typedarray = new Uint8Array(e.target.result);
                    pdfjsLib.getDocument(typedarray).promise.then(function(pdfDoc) {
                        fileEntry.docTotalPages = pdfDoc.numPages;
                        fileEntry.pdfDoc = pdfDoc; 
                        if (fileEntry.id === activeFileId) {
                            activeFileTotalPagesInput.value = fileEntry.docTotalPages;
                            activeFileTotalPagesInput.readOnly = true;
                        }
                        addDefaultSegmentForFile(fileEntry); 
                        checkAllFilesProcessed(); 
                    }).catch(err => {
                        console.error("è¯»å–PDFé¡µæ•°æ—¶å‡ºé”™ for " + fileEntry.fileName + ":", err);
                        fileEntry.docTotalPages = 1; 
                        if (fileEntry.id === activeFileId) activeFileTotalPagesInput.readOnly = false;
                        addDefaultSegmentForFile(fileEntry);
                        checkAllFilesProcessed();
                    });
                };
                reader.onerror = function() {
                    console.error("è¯»å–æ–‡ä»¶æ—¶å‡ºé”™ for " + fileEntry.fileName);
                    fileEntry.docTotalPages = 1; 
                    if (fileEntry.id === activeFileId) activeFileTotalPagesInput.readOnly = false;
                    addDefaultSegmentForFile(fileEntry);
                    checkAllFilesProcessed();
                };
                reader.readAsArrayBuffer(fileEntry.fileObject);
            } else {
                if (fileEntry.id === activeFileId) {
                    activeFileTotalPagesInput.readOnly = false;
                }
                addDefaultSegmentForFile(fileEntry);
                checkAllFilesProcessed();
            }
        }
        
        function addDefaultSegmentForFile(fileEntry) {
            if (fileEntry.printSegments.length === 0) { 
                fileEntry.segmentIdCounter = 0; 
                const newSegmentId = `${fileEntry.id}-seg-${++fileEntry.segmentIdCounter}`;
                fileEntry.printSegments.push({
                    id: newSegmentId,
                    startPage: 1,
                    endPage: fileEntry.docTotalPages || 1,
                    mode: 'single'
                });
                if (fileEntry.id === activeFileId) {
                    renderSegmentsForActiveFile(); 
                }
            }
        }


        function renderFileList() {
            fileListContainer.innerHTML = '';
            if (uploadedFilesData.length === 0) {
                noFilesMessage.classList.remove('hidden');
                activeFileConfigurationSection.classList.add('hidden');
                activeFileId = null;
                calculatePrice(); 
                return;
            }
            noFilesMessage.classList.add('hidden');

            uploadedFilesData.forEach(fileEntry => {
                const itemDiv = document.createElement('div');
                itemDiv.className = `file-item p-3 border rounded-md flex flex-wrap justify-between items-center gap-2 ${fileEntry.id === activeFileId ? 'active-file' : 'bg-white'}`;
                itemDiv.dataset.fileId = fileEntry.id;
                
                let bindingTextInList = "æ— è£…è®¢";
                const bindingOptionEl = activeFileBindingTypeSelect.querySelector(`option[value="${fileEntry.bindingType}"]`);
                if (bindingOptionEl) {
                    bindingTextInList = bindingOptionEl.textContent.split('(')[0].trim();
                }


                itemDiv.innerHTML = `
                    <div class="flex-grow min-w-0">
                        <p class="text-sm font-medium text-gray-700 truncate" title="${fileEntry.fileName}">${fileEntry.fileName}</p>
                        <p class="text-xs text-gray-500">${fileEntry.docTotalPages} é¡µ, ${fileEntry.quantity} ä»½, è£…è®¢: ${bindingTextInList}</p>
                    </div>
                    <div class="flex-shrink-0 flex gap-1">
                        <button class="configure-file-btn px-2 py-1 bg-yellow-500 text-white text-xs rounded hover:bg-yellow-600" title="é…ç½®æ­¤æ–‡ä»¶">é…ç½®</button>
                        <button class="preview-file-btn px-2 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600" ${fileEntry.fileObject.type !== 'application/pdf' ? 'disabled' : ''} title="é¢„è§ˆæ­¤PDF">é¢„è§ˆ</button>
                        <button class="remove-file-btn px-2 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600" title="ç§»é™¤æ­¤æ–‡ä»¶">ç§»é™¤</button>
                    </div>
                `;
                itemDiv.querySelector('.configure-file-btn').addEventListener('click', () => setActiveFile(fileEntry.id));
                itemDiv.querySelector('.preview-file-btn').addEventListener('click', () => previewPdfFile(fileEntry.id));
                itemDiv.querySelector('.remove-file-btn').addEventListener('click', () => removeFile(fileEntry.id));
                fileListContainer.appendChild(itemDiv);
            });
        }

        function setActiveFile(fileId) {
            activeFileId = fileId;
            const activeFile = uploadedFilesData.find(f => f.id === fileId);
            if (activeFile) {
                activeFileConfigurationSection.classList.remove('hidden');
                activeFileNameSpan.textContent = activeFile.fileName;
                activeFileTotalPagesInput.value = activeFile.docTotalPages;
                activeFileTotalPagesInput.readOnly = (activeFile.fileObject.type === "application/pdf" && activeFile.pdfDoc);
                activeFileQuantityInput.value = activeFile.quantity; 
                activeFileBindingTypeSelect.value = activeFile.bindingType; 
                updateActiveFileBindingNote(); 

                paperCategorySelect.value = activeFile.paperCategory;
                populatePaperSizes(); 
                paperSizeSelect.value = activeFile.paperSize; 
                
                if (activeFile.paperCategory === 'coated') {
                    coatedPaperWeightGroup.classList.remove('hidden');
                    coatedPaperWeightSelect.value = activeFile.coatedPaperWeight;
                } else {
                    coatedPaperWeightGroup.classList.add('hidden');
                }
                
                renderSegmentsForActiveFile(); 
                updateAllSegmentModesForA7(); 
            }
            renderFileList(); 
            calculatePrice();
        }
        
        activeFileTotalPagesInput.addEventListener('change', (e) => {
            if (activeFileId) {
                const activeFile = uploadedFilesData.find(f => f.id === activeFileId);
                if (activeFile && activeFile.fileObject.type !== "application/pdf") { 
                    activeFile.docTotalPages = parseInt(e.target.value) || 1;
                    activeFile.printSegments = [];
                    activeFile.segmentIdCounter = 0;
                    addDefaultSegmentForFile(activeFile); 
                    renderSegmentsForActiveFile(); 
                    renderFileList(); 
                    calculatePrice();
                }
            }
        });
        
        activeFileQuantityInput.addEventListener('change', (e) => {
            if (activeFileId) {
                const activeFile = uploadedFilesData.find(f => f.id === activeFileId);
                if (activeFile) {
                    activeFile.quantity = parseInt(e.target.value) || 1;
                    renderFileList(); 
                    calculatePrice();
                }
            }
        });

        activeFileBindingTypeSelect.addEventListener('change', (e) => {
            if (activeFileId) {
                const activeFile = uploadedFilesData.find(f => f.id === activeFileId);
                if (activeFile) {
                    activeFile.bindingType = e.target.value;
                    updateActiveFileBindingNote();
                    renderFileList(); 
                    calculatePrice();
                }
            }
        });
        
        function updateActiveFileBindingNote() {
            const selectedOption = activeFileBindingTypeSelect.options[activeFileBindingTypeSelect.selectedIndex];
            const note = selectedOption.dataset.note;
            activeFileBindingNoteP.textContent = note ? `å¤‡æ³¨: ${note}` : '';
        }


        function removeFile(fileId) {
            uploadedFilesData = uploadedFilesData.filter(f => f.id !== fileId);
            if (activeFileId === fileId) {
                activeFileId = null;
                activeFileConfigurationSection.classList.add('hidden');
                if (uploadedFilesData.length > 0) {
                    setActiveFile(uploadedFilesData[0].id); 
                } else {
                     renderFileList(); 
                }
            } else {
                renderFileList();
            }
            calculatePrice();
        }

        paperCategorySelect.addEventListener('change', (e) => {
            if (activeFileId) {
                const activeFile = uploadedFilesData.find(f => f.id === activeFileId);
                if (activeFile) {
                    activeFile.paperCategory = e.target.value;
                    populatePaperSizes(); 
                    activeFile.paperSize = paperSizeSelect.value; 
                    if (activeFile.paperCategory === 'coated') {
                        activeFile.coatedPaperWeight = coatedPaperWeightSelect.value; 
                    }
                }
            }
        });
        paperSizeSelect.addEventListener('change', (e) => {
            if (activeFileId) {
                const activeFile = uploadedFilesData.find(f => f.id === activeFileId);
                if (activeFile) {
                    activeFile.paperSize = e.target.value;
                    updateAllSegmentModesForA7(); 
                    calculatePrice();
                }
            }
        });
        coatedPaperWeightSelect.addEventListener('change', (e) => {
            if (activeFileId) {
                const activeFile = uploadedFilesData.find(f => f.id === activeFileId);
                if (activeFile) activeFile.coatedPaperWeight = e.target.value;
                calculatePrice();
            }
        });

        function createSegmentElement(segmentData, fileEntry) { 
            const segmentDiv = document.createElement('div');
            segmentDiv.className = 'segment-item flex flex-wrap items-center gap-2 p-3 border border-gray-300 rounded-md bg-gray-50 shadow-sm';
            segmentDiv.dataset.segmentId = segmentData.id; 
            const maxPage = fileEntry.docTotalPages || 1;
            segmentDiv.innerHTML = `
                <span class="text-sm">ä»ç¬¬</span>
                <input type="number" value="${segmentData.startPage}" min="1" max="${maxPage}" class="segment-start-page w-20 px-2 py-1 border border-gray-300 rounded-md shadow-sm text-sm focus:ring-indigo-500 focus:border-indigo-500">
                <span class="text-sm">é¡µ åˆ° ç¬¬</span>
                <input type="number" value="${segmentData.endPage}" min="1" max="${maxPage}" class="segment-end-page w-20 px-2 py-1 border border-gray-300 rounded-md shadow-sm text-sm focus:ring-indigo-500 focus:border-indigo-500">
                <span class="text-sm">é¡µï¼Œæ‰“å°æ–¹å¼:</span>
                <select class="segment-mode px-2 py-1 border border-gray-300 rounded-md shadow-sm text-sm focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="single" ${segmentData.mode === 'single' ? 'selected' : ''}>å•é¢</option>
                    <option value="double" ${segmentData.mode === 'double' ? 'selected' : ''}>åŒé¢</option>
                </select>
                <button type="button" class="remove-segment-btn ml-auto px-2 py-1 text-red-600 hover:text-red-800 text-sm font-medium" title="ç§»é™¤æ­¤åŒºé—´">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                </button>
            `;
            const startPageInput = segmentDiv.querySelector('.segment-start-page');
            const endPageInput = segmentDiv.querySelector('.segment-end-page');
            const modeSelect = segmentDiv.querySelector('.segment-mode');
            startPageInput.addEventListener('change', (e) => updateActiveFileSegmentData(segmentData.id, 'startPage', parseInt(e.target.value)));
            endPageInput.addEventListener('change', (e) => updateActiveFileSegmentData(segmentData.id, 'endPage', parseInt(e.target.value)));
            modeSelect.addEventListener('change', (e) => updateActiveFileSegmentData(segmentData.id, 'mode', e.target.value));
            segmentDiv.querySelector('.remove-segment-btn').addEventListener('click', () => removeActiveFileSegment(segmentData.id));
            return segmentDiv;
        }

        function renderSegmentsForActiveFile() {
            segmentListContainer.innerHTML = '';
            const activeFile = uploadedFilesData.find(f => f.id === activeFileId);
            if (activeFile) {
                activeFile.printSegments.forEach(segData => {
                    const el = createSegmentElement(segData, activeFile); 
                    segmentListContainer.appendChild(el);
                });
                updateAllSegmentModesForA7(); 
            }
            calculatePrice();
        }

        addSegmentBtn.addEventListener('click', () => {
            if (activeFileId) {
                const activeFile = uploadedFilesData.find(f => f.id === activeFileId);
                if (activeFile) {
                    activeFile.segmentIdCounter++;
                    const newSegmentId = `${activeFile.id}-seg-${activeFile.segmentIdCounter}`;
                    let newStartPage = 1;
                    if (activeFile.printSegments.length > 0) {
                        newStartPage = (activeFile.printSegments[activeFile.printSegments.length - 1].endPage || 0) + 1;
                        if (newStartPage > activeFile.docTotalPages && activeFile.docTotalPages > 0) newStartPage = activeFile.docTotalPages;
                        else if (newStartPage > activeFile.docTotalPages && activeFile.docTotalPages === 0) newStartPage = 1;
                    }
                    const newEndPage = activeFile.docTotalPages > 0 ? activeFile.docTotalPages : 1;
                    activeFile.printSegments.push({
                        id: newSegmentId,
                        startPage: newStartPage > 0 ? newStartPage : 1,
                        endPage: newEndPage >= newStartPage ? newEndPage : (newStartPage > 0 ? newStartPage : 1),
                        mode: 'single'
                    });
                    renderSegmentsForActiveFile();
                }
            }
        });

        function updateActiveFileSegmentData(segmentId, key, value) {
            if (activeFileId) {
                const activeFile = uploadedFilesData.find(f => f.id === activeFileId);
                if (activeFile) {
                    const segment = activeFile.printSegments.find(s => s.id === segmentId);
                    if (segment) {
                        segment[key] = value;
                        const segmentElement = segmentListContainer.querySelector(`.segment-item[data-segment-id="${segmentId}"]`);
                        if (segmentElement) {
                            const startInput = segmentElement.querySelector('.segment-start-page');
                            const endInput = segmentElement.querySelector('.segment-end-page');
                            startInput.classList.remove('invalid-segment');
                            endInput.classList.remove('invalid-segment');
                            if (segment.startPage > segment.endPage || segment.startPage < 1 || segment.endPage > activeFile.docTotalPages) {
                                if(segment.startPage > segment.endPage) startInput.classList.add('invalid-segment');
                                if(segment.endPage < segment.startPage) endInput.classList.add('invalid-segment');
                                if(segment.startPage < 1) startInput.classList.add('invalid-segment');
                                if(segment.endPage > activeFile.docTotalPages) endInput.classList.add('invalid-segment');
                            }
                        }
                    }
                    calculatePrice();
                }
            }
        }

        function removeActiveFileSegment(segmentId) {
            if (activeFileId) {
                const activeFile = uploadedFilesData.find(f => f.id === activeFileId);
                if (activeFile) {
                    activeFile.printSegments = activeFile.printSegments.filter(s => s.id !== segmentId);
                    renderSegmentsForActiveFile();
                }
            }
        }
        
        function updateAllSegmentModesForA7() { 
            if (!activeFileId) return;
            const activeFile = uploadedFilesData.find(f => f.id === activeFileId);
            if (!activeFile) return;
            segmentListContainer.querySelectorAll('.segment-item').forEach(itemDiv => {
                const modeSelect = itemDiv.querySelector('.segment-mode');
                modeSelect.disabled = false; 
            });
        }

        function previewPdfFile(fileId) { /* ... (ä¿æŒä¸å˜) ... */ 
            const fileEntry = uploadedFilesData.find(f => f.id === fileId);
            if (fileEntry && fileEntry.pdfDoc) {
                currentPreviewPdfDoc = fileEntry.pdfDoc; 
                renderAllPdfPagesForPreview(); 
            } else {
                alert("æ­¤æ–‡ä»¶ä¸æ˜¯æœ‰æ•ˆçš„PDFï¼Œæˆ–å°šæœªåŠ è½½å®Œæˆã€‚");
            }
        }
        
        function updatePreviewPageInfoOnScroll() { /* ... (ä¿æŒä¸å˜) ... */ 
            if (!currentPreviewPdfDoc || !pdfPreviewCanvasContainer.querySelector('canvas')) {
                previewPageInfoSpan.textContent = `å…± ${currentPreviewPdfDoc ? currentPreviewPdfDoc.numPages : 0} é¡µ`;
                return;
            }
            const containerScrollTop = pdfPreviewCanvasContainer.scrollTop;
            const canvases = pdfPreviewCanvasContainer.querySelectorAll('canvas');
            let currentPageInView = 1; 
            let minDistance = Infinity;
            for (const canvas of canvases) {
                const distance = Math.abs(canvas.offsetTop - containerScrollTop);
                if (distance < minDistance) {
                    minDistance = distance;
                    currentPageInView = parseInt(canvas.dataset.pageNumber);
                }
                const canvasCenter = canvas.offsetTop + canvas.offsetHeight / 2;
                if (canvasCenter >= containerScrollTop && canvasCenter <= containerScrollTop + pdfPreviewCanvasContainer.clientHeight) {
                    currentPageInView = parseInt(canvas.dataset.pageNumber);
                    break; 
                }
            }
            previewPageInfoSpan.textContent = `ç¬¬ ${currentPageInView} / ${currentPreviewPdfDoc.numPages} é¡µ`;
        }

        async function renderAllPdfPagesForPreview() { /* ... (ä¿æŒä¸å˜) ... */ 
            if (!currentPreviewPdfDoc) return;
            pdfPreviewCanvasContainer.innerHTML = ''; 
            previewPageInfoSpan.textContent = `å…± ${currentPreviewPdfDoc.numPages} é¡µï¼Œæ­£åœ¨æ¸²æŸ“ 1/${currentPreviewPdfDoc.numPages}...`;
            pdfPreviewModal.classList.remove('hidden');
            const scale = 1.5; 
            if (pdfPreviewScrollHandler) {
                pdfPreviewCanvasContainer.removeEventListener('scroll', pdfPreviewScrollHandler);
            }
            pdfPreviewScrollHandler = throttle(updatePreviewPageInfoOnScroll, 100); 
            pdfPreviewCanvasContainer.addEventListener('scroll', pdfPreviewScrollHandler);

            for (let pageNum = 1; pageNum <= currentPreviewPdfDoc.numPages; pageNum++) {
                try {
                    const page = await currentPreviewPdfDoc.getPage(pageNum);
                    const viewport = page.getViewport({ scale: scale });
                    const canvas = document.createElement('canvas');
                    canvas.dataset.pageNumber = pageNum; 
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    const canvasContext = canvas.getContext('2d');
                    const renderContext = { canvasContext: canvasContext, viewport: viewport };
                    await page.render(renderContext).promise;
                    pdfPreviewCanvasContainer.appendChild(canvas);
                    if (pageNum === currentPreviewPdfDoc.numPages) {
                         previewPageInfoSpan.textContent = `ç¬¬ 1 / ${currentPreviewPdfDoc.numPages} é¡µ (é¢„è§ˆå®Œæˆ)`;
                         updatePreviewPageInfoOnScroll(); 
                    } else {
                         previewPageInfoSpan.textContent = `å…± ${currentPreviewPdfDoc.numPages} é¡µï¼Œæ­£åœ¨æ¸²æŸ“ ${pageNum + 1}/${currentPreviewPdfDoc.numPages}...`;
                    }
                } catch (err) {
                    console.error("æ¸²æŸ“PDFé¡µé¢æ—¶å‡ºé”™:", pageNum, err);
                    const errorP = document.createElement('p');
                    errorP.textContent = `æ¸²æŸ“ç¬¬ ${pageNum} é¡µå¤±è´¥ã€‚`;
                    errorP.className = 'text-red-500 text-center py-2';
                    pdfPreviewCanvasContainer.appendChild(errorP);
                }
            }
             if (pdfPreviewCanvasContainer.children.length > 0 && currentPreviewPdfDoc.numPages > 0) {
                 updatePreviewPageInfoOnScroll(); 
            } else if (currentPreviewPdfDoc.numPages > 0) {
                 previewPageInfoSpan.textContent = `æ— æ³•æ¸²æŸ“PDF (å…± ${currentPreviewPdfDoc.numPages} é¡µ)`;
            } else {
                 previewPageInfoSpan.textContent = `æ— é¡µé¢å¯é¢„è§ˆ`;
            }
        }
        
        closePreviewModalBtn.addEventListener('click', function() { /* ... (ä¿æŒä¸å˜) ... */ 
            pdfPreviewModal.classList.add('hidden');
            pdfPreviewCanvasContainer.innerHTML = ''; 
            previewPageInfoSpan.textContent = ''; 
            if (pdfPreviewScrollHandler) { 
                pdfPreviewCanvasContainer.removeEventListener('scroll', pdfPreviewScrollHandler);
                pdfPreviewScrollHandler = null;
            }
            currentPreviewPdfDoc = null; 
        });
        pdfPreviewModal.addEventListener('click', function(event) { /* ... (ä¿æŒä¸å˜) ... */ 
            if (event.target === pdfPreviewModal) { closePreviewModalBtn.click(); }
        });

        function throttle(func, limit) { /* ... (ä¿æŒä¸å˜) ... */ 
            let lastFunc; let lastRan;
            return function(...args) {
                const context = this;
                if (!lastRan) { func.apply(context, args); lastRan = Date.now(); } 
                else { clearTimeout(lastFunc); lastFunc = setTimeout(function() {
                        if ((Date.now() - lastRan) >= limit) { func.apply(context, args); lastRan = Date.now(); }
                    }, limit - (Date.now() - lastRan));
                }
            }
        }
        
        function populatePaperSizes() { 
            if (!activeFileId) return;
            const activeFile = uploadedFilesData.find(f => f.id === activeFileId);
            if (!activeFile) return;

            const category = activeFile.paperCategory; 
            let options = '';
            coatedPaperWeightGroup.classList.add('hidden');

            if (category === 'basic') {
                options = `<option value="a4">A4</option><option value="b5">B5</option><option value="a3">A3</option><option value="a7">A7 (å°æ ‡ç­¾ç­‰)</option>`;
            } else if (category === 'colorJet') {
                options = `<option value="a4">A4</option><option value="a3">A3</option>`;
            } else if (category === 'coated') {
                options = `<option value="a4">A4 (é“œç‰ˆçº¸ä»…æ”¯æŒA4)</option>`;
                coatedPaperWeightGroup.classList.remove('hidden');
            }
            paperSizeSelect.innerHTML = options;
            const validSizesForCategory = Array.from(paperSizeSelect.options).map(opt => opt.value);
            if (!validSizesForCategory.includes(activeFile.paperSize)) {
                activeFile.paperSize = validSizesForCategory[0] || 'a4'; 
            }
            paperSizeSelect.value = activeFile.paperSize; 

            if (category === 'coated') { 
                paperSizeSelect.value = 'a4'; 
                activeFile.paperSize = 'a4';
                coatedPaperWeightSelect.value = activeFile.coatedPaperWeight; 
            }
            updateAllSegmentModesForA7(); 
            calculatePrice();
        }
        
        function updateActiveFileBindingNote() { 
            const selectedOption = activeFileBindingTypeSelect.options[activeFileBindingTypeSelect.selectedIndex];
            const note = selectedOption.dataset.note;
            activeFileBindingNoteP.textContent = note ? `å¤‡æ³¨: ${note}` : '';
        }

        function calculatePrice() {
            let totalPrintCostForAllFiles = 0;
            let totalBindingCostForAllFiles = 0;
            detailedPrintCostsBody.innerHTML = ''; 

            if (uploadedFilesData.length === 0) {
                 summaryBasePrintCostEl.textContent = '0.00 å…ƒ';
                 summaryBindingCostEl.textContent = '0.00 å…ƒ';
                 minOrderAdjustmentRow.classList.add('hidden');
                 summaryShippingCostEl.textContent = '0.00 å…ƒ';
                 summaryTotalCostEl.textContent = '0.00 å…ƒ';
                 summaryBasePrintCostLabel.textContent = `æ€»æ‰“å°è´¹ç”¨:`;
                 return;
            }

            uploadedFilesData.forEach(fileEntry => {
                let filePrintCostOneCopy = 0;
                const category = fileEntry.paperCategory;
                const currentPaperSize = fileEntry.paperSize; 
                const coatedWeight = fileEntry.coatedPaperWeight;
                const totalDocPages = fileEntry.docTotalPages || 0;
                const fileQuantity = fileEntry.quantity || 0;

                if (fileQuantity <= 0) return; 

                fileEntry.printSegments.forEach(segment => {
                    const startPage = parseInt(segment.startPage) || 0;
                    const endPage = parseInt(segment.endPage) || 0;
                    let mode = segment.mode;
                    let isValidSegment = true;

                    if (startPage <= 0 || endPage < startPage || endPage > totalDocPages) isValidSegment = false;
                    if (!isValidSegment) return; 

                    const currentEndPage = Math.min(endPage, totalDocPages);
                    if (startPage > currentEndPage) return;

                    const segmentPages = currentEndPage - startPage + 1;
                    let segmentCostPerPageSide = 0;
                    let paperDisplayName = "", colorDisplayName = "";

                    if (category === 'basic') {
                        paperDisplayName = "æ™®é€šçº¸"; colorDisplayName = "é»‘ç™½";
                        if (pricing.basicPrint[currentPaperSize]) segmentCostPerPageSide = pricing.basicPrint[currentPaperSize][mode];
                    } else if (category === 'colorJet') {
                        paperDisplayName = "å½©æ¿€çº¸"; colorDisplayName = "å½©è‰²";
                        if (pricing.colorPrintJet[currentPaperSize]) segmentCostPerPageSide = pricing.colorPrintJet[currentPaperSize][mode];
                    } else if (category === 'coated') { 
                        let coatedPaperTypeKey = coatedWeight;
                        paperDisplayName = `${pricing.colorPrintCoated[coatedPaperTypeKey] ? coatedPaperTypeKey : coatedPaperWeightSelect.options[coatedPaperWeightSelect.selectedIndex].text}é“œç‰ˆçº¸`; 
                        colorDisplayName = "å½©è‰²";
                        if (pricing.colorPrintCoated[coatedPaperTypeKey]) segmentCostPerPageSide = pricing.colorPrintCoated[coatedPaperTypeKey][mode];
                    }
                    
                    const unitPriceDescription = `(å•ä»·: ${segmentCostPerPageSide.toFixed(3)} å…ƒ/é¢)`; 
                    const costForThisSegmentOneCopy = segmentCostPerPageSide * segmentPages;
                    filePrintCostOneCopy += costForThisSegmentOneCopy;

                    const segmentDescription = `æ–‡ä»¶: ${fileEntry.fileName} (å…±${fileQuantity}ä»½) - åŒºé—´ (${startPage}-${currentEndPage}é¡µ, ${currentPaperSize.toUpperCase()} ${paperDisplayName} ${colorDisplayName} ${mode === 'single' ? 'å•é¢' : 'åŒé¢'}) ${unitPriceDescription}`;
                    
                    const tr = document.createElement('tr');
                    tr.className = 'detailed-cost-row';
                    tr.innerHTML = `
                        <td>${segmentDescription}:</td>
                        <td class="text-right font-medium">${(costForThisSegmentOneCopy * fileQuantity).toFixed(2)} å…ƒ</td>
                    `;
                    detailedPrintCostsBody.appendChild(tr);
                });
                totalPrintCostForAllFiles += (filePrintCostOneCopy * fileQuantity);
                totalBindingCostForAllFiles += (pricing.binding[fileEntry.bindingType] || 0) * fileQuantity;
            });
            
            summaryBasePrintCostLabel.textContent = `æ€»æ‰“å°è´¹ç”¨:`; 
            summaryBasePrintCostEl.textContent = `${totalPrintCostForAllFiles.toFixed(2)} å…ƒ`;
            summaryBindingCostEl.textContent = `${totalBindingCostForAllFiles.toFixed(2)} å…ƒ`;

            let subtotalBeforeMinChargeAndBinding = totalPrintCostForAllFiles + totalBindingCostForAllFiles;
            let finalSubtotalForShippingAndTotal = subtotalBeforeMinChargeAndBinding;
            
            minOrderAdjustmentRow.classList.add('hidden'); 
            if (subtotalBeforeMinChargeAndBinding > 0 && subtotalBeforeMinChargeAndBinding < pricing.policies.minOrderValue) {
                finalSubtotalForShippingAndTotal = pricing.policies.minOrderValue;
                summaryMinOrderAdjustmentEl.textContent = `${pricing.policies.minOrderValue.toFixed(2)} å…ƒ`; 
                minOrderAdjustmentRow.classList.remove('hidden');
            }
            
            let shippingCost = 0;
            if (finalSubtotalForShippingAndTotal > 0 && finalSubtotalForShippingAndTotal < pricing.policies.freeShippingThreshold) {
                shippingCost = pricing.policies.shippingFee;
            }
            summaryShippingCostEl.textContent = `${shippingCost.toFixed(2)} å…ƒ`;

            const finalTotal = finalSubtotalForShippingAndTotal + shippingCost; 
            summaryTotalCostEl.textContent = `${finalTotal.toFixed(2)} å…ƒ`;
        }

        function generateOrderNumber() { /* ... (ä¿æŒä¸å˜) ... */ 
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            const randomStr = Math.random().toString(36).substring(2, 7).toUpperCase();
            return `HYY-${year}${month}${day}-${hours}${minutes}${seconds}-${randomStr}`;
        }

        function escapeCsvCell(cellData) { /* ... (ä¿æŒä¸å˜) ... */ 
            if (typeof cellData === 'number') { return cellData.toString(); }
            if (typeof cellData === 'string') { if (cellData.includes(',') || cellData.includes('"') || cellData.includes('\n')) { return `"${cellData.replace(/"/g, '""')}"`; } return cellData; }
            return '';
        }

        function exportOrderToCsv(orderData) { 
            const headers = [
                "è®¢å•å·", "ä¸‹å•æ—¶é—´", 
                "æ–‡ä»¶å", "æ–‡ä»¶æ€»é¡µæ•°", "æ–‡ä»¶æ‰“å°ä»½æ•°", "æ–‡ä»¶çº¸å¼ ç±»åˆ«", "æ–‡ä»¶çº¸å¼ è§„æ ¼", "æ–‡ä»¶é“œç‰ˆçº¸å…‹é‡", "æ–‡ä»¶è£…è®¢ç±»å‹", "æ–‡ä»¶æ‰“å°åŒºé—´è¯¦æƒ…", "è¯¥æ–‡ä»¶æ‰“å°è´¹ç”¨(å…ƒ)", "è¯¥æ–‡ä»¶è£…è®¢è´¹ç”¨(å…ƒ)",
                "æ€»æ‰“å°è´¹ç”¨(è®¢å•çº§)", "æ€»è£…è®¢è´¹ç”¨(è®¢å•çº§)", "è¿è´¹(è®¢å•çº§)", "é¢„ä¼°æ€»ä»·(è®¢å•çº§)"
            ];
            
            let csvContent = "\uFEFF"; 
            csvContent += headers.map(header => escapeCsvCell(header)).join(',') + '\r\n';

            if (orderData.files && orderData.files.length > 0) {
                orderData.files.forEach(fileDetail => {
                    const rowData = [
                        orderData.orderNumber, orderData.orderTime,
                        fileDetail.fileName, fileDetail.docTotalPages, fileDetail.quantity,
                        fileDetail.paperCategoryText, fileDetail.paperSizeText, fileDetail.coatedWeight,
                        fileDetail.bindingTypeText, fileDetail.segmentDetails,
                        fileDetail.filePrintCost.toFixed(2), fileDetail.fileBindingCost.toFixed(2),
                        orderData.basePrintCost.replace(' å…ƒ',''), orderData.bindingCost.replace(' å…ƒ',''), 
                        orderData.shippingCost.replace(' å…ƒ',''), orderData.estimatedTotal.replace(' å…ƒ','')
                    ];
                    csvContent += rowData.map(escapeCsvCell).join(',') + '\r\n';
                });
            } else { 
                 const emptyRow = Array(headers.length).fill('');
                 emptyRow[0] = orderData.orderNumber;
                 emptyRow[1] = orderData.orderTime;
                 emptyRow[12] = orderData.basePrintCost.replace(' å…ƒ','');
                 emptyRow[13] = orderData.bindingCost.replace(' å…ƒ','');
                 emptyRow[14] = orderData.shippingCost.replace(' å…ƒ','');
                 emptyRow[15] = orderData.estimatedTotal.replace(' å…ƒ','');
                csvContent += emptyRow.map(escapeCsvCell).join(',') + '\r\n';
            }

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `å—¨äº‘å°è®¢å•_${orderData.orderNumber}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }
         }
        
        function getOrderDetailsForApi(includeFileObjects = false) {
            const orderNumber = generateOrderNumber(); 
            const now = new Date();
            const orderTime = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
            
            const filesDetailsArray = uploadedFilesData.map(fileEntry => {
                const segmentDetails = fileEntry.printSegments.map(s => {
                    let segmentCostPerPageSide = 0;
                    let tempMode = s.mode;
                    const currentPaperSize = fileEntry.paperSize; 
                    const category = fileEntry.paperCategory;   
                    const coatedWeightVal = fileEntry.coatedPaperWeight; 

                    if (category === 'basic') {
                        if (pricing.basicPrint[currentPaperSize]) segmentCostPerPageSide = pricing.basicPrint[currentPaperSize][tempMode];
                    } else if (category === 'colorJet') {
                        if (pricing.colorPrintJet[currentPaperSize]) segmentCostPerPageSide = pricing.colorPrintJet[currentPaperSize][tempMode];
                    } else if (category === 'coated') {
                        if (pricing.colorPrintCoated[coatedWeightVal]) segmentCostPerPageSide = pricing.colorPrintCoated[coatedWeightVal][tempMode];
                    }
                    return `${s.startPage}-${s.endPage}é¡µ (${s.mode === 'single' ? 'å•é¢' : 'åŒé¢'}, å•ä»·:${segmentCostPerPageSide.toFixed(3)})`;
                }).join('; ');

                let paperCategoryText = "";
                const paperCatOption = Array.from(paperCategorySelect.options).find(opt => opt.value === fileEntry.paperCategory);
                if (paperCatOption) paperCategoryText = paperCatOption.textContent;


                let paperSizeText = "";
                let tempPaperSizeSelect = document.createElement('select'); 
                if (fileEntry.paperCategory === 'basic') {
                    tempPaperSizeSelect.innerHTML = `<option value="a4">A4</option><option value="b5">B5</option><option value="a3">A3</option><option value="a7">A7 (å°æ ‡ç­¾ç­‰)</option>`;
                } else if (fileEntry.paperCategory === 'colorJet') {
                    tempPaperSizeSelect.innerHTML = `<option value="a4">A4</option><option value="a3">A3</option>`;
                } else if (fileEntry.paperCategory === 'coated') {
                    tempPaperSizeSelect.innerHTML = `<option value="a4">A4 (é“œç‰ˆçº¸ä»…æ”¯æŒA4)</option>`;
                }
                const paperSizeOption = Array.from(tempPaperSizeSelect.options).find(opt => opt.value === fileEntry.paperSize);
                if(paperSizeOption) paperSizeText = paperSizeOption.textContent;
                else paperSizeText = fileEntry.paperSize.toUpperCase(); 
                
                let coatedWeightDisplay = (fileEntry.paperCategory === 'coated') ? fileEntry.coatedPaperWeight : 'N/A';
                
                let bindingTypeTextVal = "æ— è£…è®¢";
                const bindingOption = Array.from(activeFileBindingTypeSelect.options).find(opt => opt.value === fileEntry.bindingType);
                if(bindingOption) bindingTypeTextVal = bindingOption.textContent; 

                // Calculate individual file print and binding costs
                let filePrintCostOneCopy = 0;
                fileEntry.printSegments.forEach(segment => {
                    const startPage = parseInt(segment.startPage) || 0;
                    const endPage = parseInt(segment.endPage) || 0;
                    let mode = segment.mode;
                    if (startPage <= 0 || endPage < startPage || endPage > fileEntry.docTotalPages) return;
                    const currentEndPage = Math.min(endPage, fileEntry.docTotalPages);
                    if (startPage > currentEndPage) return;
                    const segmentPages = currentEndPage - startPage + 1;
                    let segmentCostPerPageSide = 0;
                    if (fileEntry.paperCategory === 'basic') {
                        if (pricing.basicPrint[fileEntry.paperSize]) segmentCostPerPageSide = pricing.basicPrint[fileEntry.paperSize][mode];
                    } else if (fileEntry.paperCategory === 'colorJet') {
                        if (pricing.colorPrintJet[fileEntry.paperSize]) segmentCostPerPageSide = pricing.colorPrintJet[fileEntry.paperSize][mode];
                    } else if (fileEntry.paperCategory === 'coated') {
                        if (pricing.colorPrintCoated[fileEntry.coatedPaperWeight]) segmentCostPerPageSide = pricing.colorPrintCoated[fileEntry.coatedPaperWeight][mode];
                    }
                    filePrintCostOneCopy += segmentCostPerPageSide * segmentPages;
                });
                const individualFilePrintCost = filePrintCostOneCopy * fileEntry.quantity;
                const individualFileBindingCost = (pricing.binding[fileEntry.bindingType] || 0) * fileEntry.quantity;


                let fileInfoString = `æ–‡ä»¶å: ${fileEntry.fileName}, æ€»é¡µæ•°: ${fileEntry.docTotalPages}, ä»½æ•°: ${fileEntry.quantity}, è£…è®¢: ${bindingTypeTextVal.split('(')[0].trim()}, çº¸å¼ ç±»åˆ«: ${paperCategoryText}, çº¸å¼ è§„æ ¼: ${paperSizeText}, é“œç‰ˆçº¸å…‹é‡: ${coatedWeightDisplay}, åŒºé—´: ${segmentDetails}, æ–‡ä»¶æ‰“å°è´¹: ${individualFilePrintCost.toFixed(2)}å…ƒ, æ–‡ä»¶è£…è®¢è´¹: ${individualFileBindingCost.toFixed(2)}å…ƒ`;
                
                let returnObj = { 
                    details: fileInfoString, 
                    fileName: fileEntry.fileName,
                    docTotalPages: fileEntry.docTotalPages,
                    quantity: fileEntry.quantity,
                    paperCategoryText: paperCategoryText,
                    paperSizeText: paperSizeText,
                    coatedWeight: coatedWeightDisplay,
                    bindingTypeText: bindingTypeTextVal, 
                    segmentDetails: segmentDetails,
                    filePrintCost: individualFilePrintCost, 
                    fileBindingCost: individualFileBindingCost 
                 };

                if (includeFileObjects) {
                    returnObj.fileObject = fileEntry.fileObject;
                }
                return returnObj;
            });


            const orderDetails = {
                orderNumber: orderNumber, orderTime: orderTime,
                basePrintCost: summaryBasePrintCostEl.textContent, 
                bindingCost: summaryBindingCostEl.textContent,
                shippingCost: summaryShippingCostEl.textContent, 
                estimatedTotal: summaryTotalCostEl.textContent,
                logoUsed: siteLogo.src,
                files: filesDetailsArray 
            };
            
            return orderDetails;
        }


        // Event Listeners
        submitOrderButton.addEventListener('click', () => {
            if (uploadedFilesData.length === 0) {
                alert("è¯·è‡³å°‘ä¸Šä¼ ä¸€ä¸ªæ–‡ä»¶å†æäº¤è®¢å•ã€‚");
                return;
            }
            const orderDetails = getOrderDetailsForApi(false); 
            exportOrderToCsv(orderDetails); 
            
            // submitOrderButton.classList.add('hidden'); // No longer hiding
            // document.querySelector('.payment-buttons-container').classList.remove('hidden'); // No longer showing based on this click

            alert(`è®¢å•å·²ç”Ÿæˆï¼\nè®¢å•å·: ${orderDetails.orderNumber}\nè®¢å•è¯¦æƒ…CSVæ–‡ä»¶å·²å¼€å§‹ä¸‹è½½ã€‚\n\nè¯·é€šè¿‡å¾®ä¿¡ç§èŠå‘é€åŸå§‹æ‰“å°æ–‡ä»¶ã€å¯¼å‡ºçš„è®¢å•CSVæ–‡ä»¶å’Œæ”¶è´§ä¿¡æ¯ç­‰ä»¥æœ€ç»ˆç¡®è®¤è®¢å•ã€‚`);
        });

        // sendToWeComBtn event listener removed


        alipayBtn.addEventListener('click', function() {
            const totalAmount = summaryTotalCostEl.textContent;
            alipayQrPaymentAmountEl.textContent = `é‡‘é¢: ${totalAmount}`;
            alipayQrPaymentModal.classList.remove('hidden');
        });

        qrPayBtn.addEventListener('click', function() {
            const totalAmount = summaryTotalCostEl.textContent;
            qrPaymentAmountEl.textContent = `é‡‘é¢: ${totalAmount}`;
            qrPaymentModal.classList.remove('hidden');
        });

        closeQrModalBtn.addEventListener('click', function() {
            qrPaymentModal.classList.add('hidden');
        });
        qrPaymentModal.addEventListener('click', function(event) {
            if (event.target === qrPaymentModal) {
                qrPaymentModal.classList.add('hidden');
            }
        });

        closeAlipayQrModalBtn.addEventListener('click', function() { 
            alipayQrPaymentModal.classList.add('hidden');
        });
        alipayQrPaymentModal.addEventListener('click', function(event) { 
            if (event.target === alipayQrPaymentModal) {
                alipayQrPaymentModal.classList.add('hidden');
            }
        });


        document.addEventListener('DOMContentLoaded', () => {
            renderFileList(); 
            calculatePrice();
        });
    </script>

</body>
</html>
