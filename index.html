<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã€å—¨äº‘å°ã€‘åœ¨çº¿ä¸‹å•ä¸ä»·æ ¼è®¡ç®—</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .price-table th, .price-table td { padding: 8px 12px; text-align: left; }
        select:disabled, button:disabled { background-color: #e9ecef; opacity: 0.7; cursor: not-allowed; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        .logo-img { max-height: 80px; margin-bottom: 1rem; }
        .pdf-preview-modal { position: fixed; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .pdf-preview-modal-content { background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 90vw; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; }
        .pdf-preview-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .pdf-preview-canvas-container { flex-grow: 1; overflow-y: auto; border: 1px solid #ccc; background-color: #f9f9f9; }
        .pdf-preview-canvas-container canvas { max-width: 100%; height: auto; display: block; margin: 0 auto 10px auto; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .segment-item input.invalid-segment, .segment-item select.invalid-segment {
            border-color: red !important;
        }
        .detailed-cost-row td {
            padding-top: 2px;
            padding-bottom: 2px;
            font-size: 0.8rem; /* Smaller font for details */
            color: #4A5568; /* Gray-700 */
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-4xl">
        <header class="mb-8 text-center">
            <img src="https://i.postimg.cc/X7ywMj8b/16661747226997-pic-hd.jpg" alt="å—¨äº‘å° Logo" id="siteLogo" class="logo-img mx-auto">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">ã€å—¨äº‘å°ã€‘åœ¨çº¿ä¸‹å•ä¸ä»·æ ¼è®¡ç®—</h1>
            <p class="text-gray-600 mt-2">ç”±åœ¨æ ¡å­¦é•¿/å­¦å§ç”¨å¿ƒç»è¥ï¼Œä¸ºæ‚¨æä¾›ä¾¿æ·ã€å®æƒ ã€ä¼˜è´¨çš„æ‰“å°æœåŠ¡ï¼</p>
        </header>

        <section id="fileUploadSection" class="mb-8 p-6 bg-white rounded-xl shadow-lg">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">1. ä¸Šä¼ æ–‡ä»¶ä¸åŸºæœ¬ä¿¡æ¯</h2>
            <div class="mb-4">
                <label for="fileUpload" class="block text-sm font-medium text-gray-700 mb-1">é€‰æ‹©æ–‡ä»¶ (æ¨èPDF)</label>
                <input type="file" id="fileUpload" name="fileUpload" accept="application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,.ppt,.pptx" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 transition-colors">
                <p id="fileUploadStatus" class="mt-1 text-xs text-gray-500">PDFæ ¼å¼å¯è‡ªåŠ¨è®¡ç®—é¡µæ•°å¹¶æ”¯æŒé¢„è§ˆã€‚Wordç­‰å…¶ä»–æ ¼å¼è¯·æ‰‹åŠ¨è¾“å…¥é¡µæ•°ã€‚æ¨èè½¬æ¢ä¸ºPDFåä¸Šä¼ ã€‚</p>
            </div>
            <div>
                <label for="pagesPerDocument" class="block text-sm font-medium text-gray-700 mb-1">æ–‡æ¡£æ€»é¡µæ•° (å•é¢ç®—1é¡µï¼ŒåŒé¢å°1å¼ çº¸ç®—2é¡µ)</label>
                <input type="number" id="pagesPerDocument" name="pagesPerDocument" value="1" min="1" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" readonly>
                <p class="mt-1 text-xs text-gray-500">PDFæ–‡ä»¶å°†è‡ªåŠ¨è®¡ç®—æ€»é¡µæ•°ã€‚æ­¤é¡µæ•°ä¸ºå‚è€ƒï¼Œå®é™…è®¡è´¹æŒ‰ä¸‹æ–¹åˆ†æ®µè®¾ç½®ã€‚</p>
            </div>
            <div class="mt-4">
                <button id="printPreviewBtn" class="px-4 py-2 bg-blue-500 text-white text-sm font-medium rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:bg-gray-300" disabled>
                    æ‰“å°é¢„è§ˆ (PDF)
                </button>
            </div>
        </section>

        <section id="printingOptionsSection" class="mb-8 p-6 bg-white rounded-xl shadow-lg">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">2. æ‰“å°é€‰é¡¹</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="paperCategory" class="block text-sm font-medium text-gray-700 mb-1">çº¸å¼ ç±»åˆ«</label>
                    <select id="paperCategory" name="paperCategory" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        <option value="basic">æ™®é€šæ•°ç æ‰“å°çº¸ (é»‘ç™½)</option>
                        <option value="colorJet">å½©æ¿€çº¸ (å½©è‰²)</option>
                        <option value="coated">é“œç‰ˆçº¸ (å½©è‰²)</option>
                    </select>
                </div>
                <div>
                    <label for="paperSize" class="block text-sm font-medium text-gray-700 mb-1">çº¸å¼ è§„æ ¼</label>
                    <select id="paperSize" name="paperSize" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </select>
                </div>
                <div id="coatedPaperWeightGroup" class="hidden">
                    <label for="coatedPaperWeight" class="block text-sm font-medium text-gray-700 mb-1">é“œç‰ˆçº¸å…‹é‡ (A4)</label>
                    <select id="coatedPaperWeight" name="coatedPaperWeight" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        <option value="128g">128g</option>
                        <option value="157g">157g</option>
                        <option value="200g">200g</option>
                        <option value="250g">250g</option>
                        <option value="300g">300g</option>
                    </select>
                </div>
                <div>
                    <label for="quantity" class="block text-sm font-medium text-gray-700 mb-1">æ‰“å°ä»½æ•°</label>
                    <input type="number" id="quantity" name="quantity" value="1" min="1" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
            </div>

            <div id="printSegmentsSection" class="mt-6 p-4 border border-gray-200 rounded-lg shadow">
                <h3 class="text-xl font-semibold text-gray-800 mb-3">åˆ†æ®µæ‰“å°è®¾ç½®</h3>
                <div id="segmentListContainer" class="space-y-4 mb-4">
                    </div>
                <button id="addSegmentBtn" type="button" class="px-4 py-2 text-sm bg-green-500 hover:bg-green-600 text-white rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                    æ·»åŠ æ‰“å°åŒºé—´
                </button>
                <p class="text-xs text-gray-500 mt-3">
                    è¯·ç¡®ä¿æ‰€æœ‰é¡µç åŒºé—´ä¸é‡å ï¼Œå¹¶è¦†ç›–æ‰€æœ‰éœ€è¦æ‰“å°çš„é¡µé¢ã€‚æ€»é¡µæ•°å‚è€ƒæ–‡ä»¶ä¸Šä¼ åè‡ªåŠ¨è·å–çš„é¡µæ•°ã€‚
                </p>
            </div>
        </section>

        <section id="bindingOptionsSection" class="mb-8 p-6 bg-white rounded-xl shadow-lg">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">3. è£…è®¢æœåŠ¡ (å¯é€‰)</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="bindingType" class="block text-sm font-medium text-gray-700 mb-1">é€‰æ‹©è£…è®¢ç±»å‹ (å†…é¡µæ‰“å°è´¹å¦è®¡)</label>
                    <select id="bindingType" name="bindingType" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        <option value="none">æ— è£…è®¢</option>
                        <optgroup label="èƒ¶è£…ç±» (ç‰¹æƒ å¼•æµ)">
                            <option value="coatedNoFilm" data-note="å«æŒ‡å®šå°é¢">é“œç‰ˆçº¸èƒ¶è£… (ä¸è¦†è†œ)</option>
                            <option value="coatedFilm" data-note="å«æŒ‡å®šå°é¢">é“œç‰ˆçº¸èƒ¶è£… (è¦†è†œ)</option>
                            <option value="texturedNoText" data-note="å«æŒ‡å®šå°é¢">çš®çº¹çº¸èƒ¶è£… (ä¸å°å­—)</option>
                            <option value="texturedText" data-note="å«æŒ‡å®šå°é¢">çš®çº¹çº¸èƒ¶è£… (å°å­—)</option>
                            <option value="kraftNoText" data-note="å«æŒ‡å®šå°é¢">ç‰›çš®çº¸èƒ¶è£… (ä¸å°å­—)</option>
                            <option value="kraftText" data-note="å«æŒ‡å®šå°é¢">ç‰›çš®çº¸èƒ¶è£… (å°å­—)</option>
                        </optgroup>
                        <optgroup label="å…¶ä»–è£…è®¢åŠç²¾è£…ç±» (æˆæœ¬ x 2.0å€)">
                            <option value="staple" data-note="æ— å°é¢ (å°é¢å¦è®¡)">è®¢ä¹¦é’ˆè£…è®¢</option>
                            <option value="saddleStitch" data-note="ä¸å«æ‰“å°å°é¢ (å°é¢å¦è®¡)ï¼Œæœ‰Pæ•°å’Œå€æ•°é™åˆ¶">éª‘é©¬é’‰è£…è®¢</option>
                            <option value="wireO" data-note="å¸¦é€æ˜èƒ¶ç‰‡ï¼Œä¸å«æ‰“å°å°é¢ (å°é¢å¦è®¡)">é“åœˆè£…è®¢</option>
                            <option value="looseLeaf" data-note="å¸¦é€æ˜èƒ¶ç‰‡">æ´»é¡µå¤¹è£…è®¢</option>
                            <option value="hardCover" data-note="é«˜ç«¯ç²¾è£…ï¼Œä¸å«å†…é¡µæ‰“å°è´¹">ç¡¬å£³ç²¾è£…</option>
                            <option value="butterfly" data-note="é«˜ç«¯ç²¾è£…ï¼Œä¸å«å†…é¡µæ‰“å°è´¹">è´è¶ç²¾è£…</option>
                        </optgroup>
                    </select>
                    <p id="bindingNote" class="mt-1 text-xs text-gray-500"></p>
                </div>
            </div>
        </section>

        <section id="priceSummarySection" class="mb-8 p-6 bg-gray-50 rounded-xl shadow-lg sticky top-4">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">ä»·æ ¼æ€»è§ˆ</h2>
            <table class="w-full price-table text-sm text-gray-700">
                <tbody id="detailedPrintCostsBody">
                    </tbody>
                <tbody> <tr id="basePrintCostRow"> <td id="summaryBasePrintCostLabel">æ€»æ‰“å°è´¹ç”¨:</td>
                        <td id="summaryBasePrintCost" class="text-right font-medium">0.00 å…ƒ</td>
                    </tr>
                    <tr>
                        <td>è£…è®¢è´¹ç”¨:</td>
                        <td id="summaryBindingCost" class="text-right font-medium">0.00 å…ƒ</td>
                    </tr>
                    <tr id="minOrderAdjustmentRow" class="hidden"> <td id="minOrderAdjustmentLabel">æœ€ä½èµ·å°:</td>
                        <td id="summaryMinOrderAdjustment" class="text-right font-medium">0.00 å…ƒ</td>
                    </tr>
                    <tr> <td>è¿è´¹:</td>
                        <td id="summaryShippingCost" class="text-right font-medium">0.00 å…ƒ</td>
                    </tr>
                    <tr class="border-t-2 border-gray-300">
                        <td class="text-lg font-semibold">é¢„ä¼°æ€»ä»·:</td>
                        <td id="summaryTotalCost" class="text-right text-lg font-semibold text-indigo-600">0.00 å…ƒ</td>
                    </tr>
                </tbody>
            </table>
            <div class="mt-4 text-xs text-gray-500">
                <p>æœ€ä½èµ·å°ï¼šæœ¬åº—æ‰“å°åŠç›¸å…³æœåŠ¡ï¼ˆä¸å«é‚®è´¹éƒ¨åˆ†ï¼‰æœ€ä½èµ·å°ä¸º 5.00å…ƒã€‚</p>
                <p>åŒ…é‚®æ”¿ç­–ï¼šè®¢å•æ€»é‡‘é¢ (å«æ‰€æœ‰æ‰“å°ã€è£…è®¢ç­‰è´¹ç”¨) æ»¡ 25.00 å…ƒåŒ…é‚®ã€‚</p>
                <p>é‚®è´¹æ ‡å‡†ï¼šè®¢å•æ€»é‡‘é¢ä¸è¶³25.00å…ƒåŒ…é‚®é—¨æ§›çš„ï¼Œç»Ÿä¸€æ”¶å– 6.00å…ƒ è¿è´¹ã€‚</p>
            </div>
             <button id="submitOrder" class="mt-6 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:shadow-lg transition-all duration-150 ease-in-out">
                ç¡®è®¤è®¢å•å¹¶å¯¼å‡ºCSV
            </button>
        </section>

        <section id="infoSection" class="p-6 bg-white rounded-xl shadow-lg">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">å…¶ä»–è¯´æ˜ä¸æ¸©é¦¨æç¤º</h2>
            <ul class="list-disc list-inside space-y-2 text-sm text-gray-600">
                <li><strong>æ— ç‰ŒåŒ…è£…ï¼š</strong> æ‰€æœ‰è®¢å•å‡é‡‡ç”¨æ— å“ç‰Œæ ‡è¯†çš„åŒ…è£…å‘è´§ï¼Œä¿æŠ¤æ‚¨çš„éšç§ã€‚</li>
                <li><strong>ä¸‹å•æµç¨‹ï¼š</strong> æ­¤ç½‘é¡µå¯è¾…åŠ©æ‚¨ä¼°ç®—ä»·æ ¼å¹¶ç”Ÿæˆè®¢å•è®°å½• (CSVæ–‡ä»¶)ã€‚è¯·é€šè¿‡å¾®ä¿¡ç§èŠå‘é€åŸå§‹æ‰“å°æ–‡ä»¶ã€å¯¼å‡ºçš„è®¢å•CSVæ–‡ä»¶ä»¥åŠè¯¦ç»†æ‰“å°è¦æ±‚ï¼ˆå¦‚æ”¶è´§ä¿¡æ¯ç­‰ï¼‰ï¼Œæˆ‘ä»¬å°†å°½å¿«ä¸æ‚¨ç¡®è®¤è®¢å•è¯¦æƒ…å’Œæ€»é‡‘é¢ã€‚</li>
                <li><strong>æ–‡ä»¶æ ¼å¼ï¼š</strong> æ¨èä½¿ç”¨PDFæ ¼å¼ä»¥ç¡®ä¿æ‰“å°æ•ˆæœã€é¡µæ•°è‡ªåŠ¨è®¡ç®—å’Œå†…å®¹é¢„è§ˆã€‚å…¶ä»–æ ¼å¼ï¼ˆå¦‚Word, PPTï¼‰è¯·æå‰å’¨è¯¢ï¼Œå¯èƒ½éœ€è¦è½¬æ¢ä¸ºPDFï¼Œå¹¶è¯·æ‰‹åŠ¨è¾“å…¥é¡µæ•°ã€‚</li>
                <li><strong>å…³äºæˆ‘ä»¬ï¼š</strong> â€œå—¨äº‘å°â€ç”±åœ¨æ ¡å­¦é•¿/å­¦å§ç”¨å¿ƒç»è¥ï¼Œè‡´åŠ›äºä¸ºåŒå­¦ä»¬æä¾›ä¾¿æ·ã€å®æƒ ã€ä¼˜è´¨çš„æ‰“å°æœåŠ¡ï¼ğŸ˜Š</li>
                <li><strong>ä»·æ ¼ç¡®è®¤ï¼š</strong> å¦‚æœ‰ç‰¹æ®Šæ‰“å°éœ€æ±‚æˆ–å¯¹ä»·æ ¼æœ‰ç–‘é—®ï¼Œè¯·éšæ—¶ä¸æˆ‘ä»¬æ²Ÿé€šç¡®è®¤ã€‚æ­¤è®¡ç®—å™¨ä»·æ ¼ä¸ºå‚è€ƒï¼Œæœ€ç»ˆä»·æ ¼ä»¥å®¢æœç¡®è®¤ä¸ºå‡†ã€‚</li>
                <li><strong>éª‘é©¬é’‰å¤‡æ³¨ï¼š</strong> è‹¥é€‰æ‹©éª‘é©¬é’‰è£…è®¢ï¼Œè¯·ç¡®ä¿æ–‡æ¡£é¡µæ•° (Pæ•°) ä¸º4çš„å€æ•°ï¼Œä¸”æ€»é¡µæ•°åœ¨40Pï¼ˆå³10å¼ çº¸ï¼‰ä»¥ä¸‹ã€‚</li>
            </ul>
        </section>

        <footer class="mt-12 text-center text-sm text-gray-500">
            <p>&copy; 2024-2025 ã€å—¨äº‘å°ã€‘ç‰ˆæƒæ‰€æœ‰</p>
        </footer>
    </div>

    <div id="pdfPreviewModal" class="pdf-preview-modal hidden">
        <div class="pdf-preview-modal-content">
            <div class="pdf-preview-header">
                <h3 class="text-xl font-semibold">PDF é¢„è§ˆ</h3>
                <span id="previewPageInfo" class="text-sm text-gray-600"></span>
                <button id="closePreviewModalBtn" class="text-gray-700 hover:text-red-500 text-2xl">&times;</button>
            </div>
            <div id="pdfPreviewCanvasContainer" class="pdf-preview-canvas-container">
            </div>
        </div>
    </div>

    <script>
        const pricing = {
            basicPrint: {
                a7: { single: 0.03, double: 0.03 },
                a4: { single: 0.18, double: 0.125 },
                b5: { single: 0.15, double: 0.115 },
                a3: { single: 0.35, double: 0.25 }
            },
            colorPrintJet: {
                a4: { single: 1.00, double: 0.75 },
                a3: { single: 2.00, double: 1.50 }
            },
            colorPrintCoated: {
                '128g': { single: 1.50, double: 1.00 },
                '157g': { single: 2.00, double: 1.25 },
                '200g': { single: 2.25, double: 1.50 },
                '250g': { single: 2.50, double: 1.75 },
                '300g': { single: 3.00, double: 2.00 }
            },
            binding: {
                none: 0,
                coatedNoFilm: 7.0,
                coatedFilm: 8.0,
                texturedNoText: 4.0,
                texturedText: 5.0,
                kraftNoText: 4.0,
                kraftText: 5.0,
                staple: 0.4,
                saddleStitch: 4.0,
                wireO: 10.0,
                looseLeaf: 10.0,
                hardCover: 140.0,
                butterfly: 180.0
            },
            policies: {
                minOrderValue: 5.00,
                freeShippingThreshold: 25.00,
                shippingFee: 6.00
            }
        };

        const fileUploadInput = document.getElementById('fileUpload');
        const fileUploadStatusP = document.getElementById('fileUploadStatus');
        const paperCategorySelect = document.getElementById('paperCategory');
        const paperSizeSelect = document.getElementById('paperSize');
        const coatedPaperWeightGroup = document.getElementById('coatedPaperWeightGroup');
        const coatedPaperWeightSelect = document.getElementById('coatedPaperWeight');
        const pagesPerDocumentInput = document.getElementById('pagesPerDocument');
        const quantityInput = document.getElementById('quantity');
        const bindingTypeSelect = document.getElementById('bindingType');
        const bindingNoteP = document.getElementById('bindingNote');

        const printPreviewBtn = document.getElementById('printPreviewBtn');
        const pdfPreviewModal = document.getElementById('pdfPreviewModal');
        const pdfPreviewCanvasContainer = document.getElementById('pdfPreviewCanvasContainer');
        const closePreviewModalBtn = document.getElementById('closePreviewModalBtn');
        const previewPageInfoSpan = document.getElementById('previewPageInfo');

        const segmentListContainer = document.getElementById('segmentListContainer');
        const addSegmentBtn = document.getElementById('addSegmentBtn');
        let printSegments = [];
        let segmentIdCounter = 0;

        const detailedPrintCostsBody = document.getElementById('detailedPrintCostsBody');
        const summaryBasePrintCostLabel = document.getElementById('summaryBasePrintCostLabel');
        const summaryBasePrintCostEl = document.getElementById('summaryBasePrintCost');
        const summaryBindingCostEl = document.getElementById('summaryBindingCost');
        const minOrderAdjustmentRow = document.getElementById('minOrderAdjustmentRow');
        const summaryMinOrderAdjustmentEl = document.getElementById('summaryMinOrderAdjustment');
        const summaryShippingCostEl = document.getElementById('summaryShippingCost');
        const summaryTotalCostEl = document.getElementById('summaryTotalCost');
        const submitOrderButton = document.getElementById('submitOrder');
        const siteLogo = document.getElementById('siteLogo');

        let currentPdfDocument = null;
        let pdfPreviewScrollHandler = null;

        function createSegmentElement(segmentData) {
            const segmentDiv = document.createElement('div');
            segmentDiv.className = 'segment-item flex flex-wrap items-center gap-2 p-3 border border-gray-300 rounded-md bg-gray-50 shadow-sm';
            segmentDiv.dataset.segmentId = segmentData.id;
            const maxPage = parseInt(pagesPerDocumentInput.value) || 1;
            segmentDiv.innerHTML = `
                <span class="text-sm">ä»ç¬¬</span>
                <input type="number" value="${segmentData.startPage}" min="1" max="${maxPage}" class="segment-start-page w-20 px-2 py-1 border border-gray-300 rounded-md shadow-sm text-sm focus:ring-indigo-500 focus:border-indigo-500">
                <span class="text-sm">é¡µ åˆ° ç¬¬</span>
                <input type="number" value="${segmentData.endPage}" min="1" max="${maxPage}" class="segment-end-page w-20 px-2 py-1 border border-gray-300 rounded-md shadow-sm text-sm focus:ring-indigo-500 focus:border-indigo-500">
                <span class="text-sm">é¡µï¼Œæ‰“å°æ–¹å¼:</span>
                <select class="segment-mode px-2 py-1 border border-gray-300 rounded-md shadow-sm text-sm focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="single" ${segmentData.mode === 'single' ? 'selected' : ''}>å•é¢</option>
                    <option value="double" ${segmentData.mode === 'double' ? 'selected' : ''}>åŒé¢</option>
                </select>
                <button type="button" class="remove-segment-btn ml-auto px-2 py-1 text-red-600 hover:text-red-800 text-sm font-medium" title="ç§»é™¤æ­¤åŒºé—´">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                </button>
            `;
            const startPageInput = segmentDiv.querySelector('.segment-start-page');
            const endPageInput = segmentDiv.querySelector('.segment-end-page');
            const modeSelect = segmentDiv.querySelector('.segment-mode');
            startPageInput.addEventListener('change', (e) => updateSegmentData(segmentData.id, 'startPage', parseInt(e.target.value)));
            endPageInput.addEventListener('change', (e) => updateSegmentData(segmentData.id, 'endPage', parseInt(e.target.value)));
            modeSelect.addEventListener('change', (e) => updateSegmentData(segmentData.id, 'mode', e.target.value));
            segmentDiv.querySelector('.remove-segment-btn').addEventListener('click', () => removeSegment(segmentData.id));
            return segmentDiv;
        }

        function renderSegments() {
            segmentListContainer.innerHTML = '';
            printSegments.forEach(segData => {
                const el = createSegmentElement(segData);
                segmentListContainer.appendChild(el);
            });
            updateAllSegmentModesForA7();
            calculatePrice();
        }

        function addSegment() {
            segmentIdCounter++;
            const totalPages = parseInt(pagesPerDocumentInput.value) || 1;
            let newStartPage = 1;
            if (printSegments.length > 0) {
                newStartPage = (printSegments[printSegments.length - 1].endPage || 0) + 1;
                if (newStartPage > totalPages && totalPages > 0) newStartPage = totalPages;
                else if (newStartPage > totalPages && totalPages === 0) newStartPage = 1;
            }
             const newEndPage = totalPages > 0 ? totalPages : 1;

            const newSegment = {
                id: segmentIdCounter,
                startPage: newStartPage > 0 ? newStartPage : 1,
                endPage: newEndPage >= newStartPage ? newEndPage : (newStartPage > 0 ? newStartPage : 1),
                mode: 'single'
            };
            printSegments.push(newSegment);
            renderSegments();
        }

        addSegmentBtn.addEventListener('click', addSegment);

        function updateSegmentData(id, key, value) {
            const segment = printSegments.find(s => s.id === id);
            if (segment) {
                segment[key] = value;
                const segmentElement = segmentListContainer.querySelector(`.segment-item[data-segment-id="${id}"]`);
                if (segmentElement) {
                    const startInput = segmentElement.querySelector('.segment-start-page');
                    const endInput = segmentElement.querySelector('.segment-end-page');
                    startInput.classList.remove('invalid-segment');
                    endInput.classList.remove('invalid-segment');
                    const totalDocPages = parseInt(pagesPerDocumentInput.value) || 0;
                    if (segment.startPage > segment.endPage || segment.startPage < 1 || segment.endPage > totalDocPages) {
                        if (segment.startPage > segment.endPage) startInput.classList.add('invalid-segment');
                        if (segment.endPage < segment.startPage) endInput.classList.add('invalid-segment');
                        if (segment.startPage < 1) startInput.classList.add('invalid-segment');
                        if (segment.endPage > totalDocPages) endInput.classList.add('invalid-segment');
                    }
                }
            }
            calculatePrice();
        }

        function removeSegment(id) {
            printSegments = printSegments.filter(s => s.id !== id);
            renderSegments();
        }

        function updateAllSegmentModesForA7() {
            document.querySelectorAll('.segment-item .segment-mode').forEach(modeSelect => {
                 modeSelect.disabled = false;
            });
        }

        fileUploadInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            currentPdfDocument = null;
            printPreviewBtn.disabled = true;
            pdfPreviewCanvasContainer.innerHTML = '';
            printSegments = [];
            segmentIdCounter = 0;
            pagesPerDocumentInput.readOnly = true;

            if (!file) {
                fileUploadStatusP.textContent = 'æœªé€‰æ‹©æ–‡ä»¶ã€‚PDFæ ¼å¼å¯è‡ªåŠ¨è®¡ç®—é¡µæ•°å¹¶æ”¯æŒé¢„è§ˆã€‚Wordç­‰å…¶ä»–æ ¼å¼è¯·æ‰‹åŠ¨è¾“å…¥é¡µæ•°ã€‚';
                fileUploadStatusP.className = 'mt-1 text-xs text-gray-500';
                pagesPerDocumentInput.value = 1;
                addSegment();
                calculatePrice();
                return;
            }

            const fileType = file.type;
            const fileName = file.name.toLowerCase();

            if (fileType === "application/pdf") {
                fileUploadStatusP.textContent = 'æ­£åœ¨è¯»å–PDFé¡µæ•°...';
                fileUploadStatusP.className = 'mt-1 text-xs text-blue-600';
                const reader = new FileReader();
                reader.onload = function(e) {
                    const typedarray = new Uint8Array(e.target.result);
                    pdfjsLib.getDocument(typedarray).promise.then(function(pdfDoc) {
                        currentPdfDocument = pdfDoc;
                        printPreviewBtn.disabled = false;
                        pagesPerDocumentInput.value = pdfDoc.numPages;
                        fileUploadStatusP.textContent = `PDFé¡µæ•°è‡ªåŠ¨è·å–æˆåŠŸ: ${pdfDoc.numPages} é¡µã€‚å¯ç‚¹å‡»é¢„è§ˆã€‚`;
                        fileUploadStatusP.className = 'mt-1 text-xs text-green-600';
                        printSegments = [];
                        segmentIdCounter = 0;
                        addSegment();
                        calculatePrice();
                    }).catch(function(error) {
                        fileUploadStatusP.textContent = 'æ— æ³•è‡ªåŠ¨è¯»å–PDFé¡µæ•°ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥ã€‚';
                        fileUploadStatusP.className = 'mt-1 text-xs text-red-600';
                        pagesPerDocumentInput.value = 1;
                        pagesPerDocumentInput.readOnly = false;
                        addSegment();
                        calculatePrice();
                    });
                };
                reader.onerror = function() {
                    fileUploadStatusP.textContent = 'è¯»å–æ–‡ä»¶å¤±è´¥ï¼Œè¯·é‡è¯•æˆ–æ‰‹åŠ¨è¾“å…¥é¡µæ•°ã€‚';
                    fileUploadStatusP.className = 'mt-1 text-xs text-red-600';
                    pagesPerDocumentInput.value = 1;
                    pagesPerDocumentInput.readOnly = false;
                    addSegment();
                    calculatePrice();
                };
                reader.readAsArrayBuffer(file);
            } else if (fileType === "application/msword" ||
                       fileType === "application/vnd.openxmlformats-officedocument.wordprocessingml.document" ||
                       fileName.endsWith(".doc") || fileName.endsWith(".docx")) {
                fileUploadStatusP.textContent = 'Wordæ–‡æ¡£ä¸æ”¯æŒè‡ªåŠ¨è®¡ç®—é¡µæ•°å’Œé¢„è§ˆï¼Œè¯·æ‰‹åŠ¨è¾“å…¥å‡†ç¡®æ€»é¡µæ•°åï¼Œå†è®¾ç½®æ‰“å°åŒºé—´ã€‚';
                fileUploadStatusP.className = 'mt-1 text-xs text-orange-600 font-semibold';
                pagesPerDocumentInput.value = 1;
                pagesPerDocumentInput.readOnly = false;
                pagesPerDocumentInput.focus();
                addSegment();
                calculatePrice();
            } else {
                fileUploadStatusP.textContent = 'ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ã€‚è¯·æ‰‹åŠ¨è¾“å…¥æ€»é¡µæ•°åï¼Œå†è®¾ç½®æ‰“å°åŒºé—´ã€‚æ¨èä½¿ç”¨PDFã€‚';
                fileUploadStatusP.className = 'mt-1 text-xs text-red-600';
                pagesPerDocumentInput.value = 1;
                pagesPerDocumentInput.readOnly = false;
                addSegment();
                calculatePrice();
            }
        });

        pagesPerDocumentInput.addEventListener('change', () => {
            if (fileUploadInput.files.length === 0 || (fileUploadInput.files[0] && fileUploadInput.files[0].type !== "application/pdf")) {
                printSegments = [];
                segmentIdCounter = 0;
                addSegment();
            }
        });

        function updatePreviewPageInfoOnScroll() { /* ... (ä¿æŒä¸å˜) ... */
            if (!currentPdfDocument || !pdfPreviewCanvasContainer.querySelector('canvas')) {
                previewPageInfoSpan.textContent = `å…± ${currentPdfDocument ? currentPdfDocument.numPages : 0} é¡µ`;
                return;
            }
            const containerScrollTop = pdfPreviewCanvasContainer.scrollTop;
            const canvases = pdfPreviewCanvasContainer.querySelectorAll('canvas');
            let currentPageInView = 1;
            let minDistance = Infinity;
            for (const canvas of canvases) {
                const distance = Math.abs(canvas.offsetTop - containerScrollTop);
                if (distance < minDistance) {
                    minDistance = distance;
                    currentPageInView = parseInt(canvas.dataset.pageNumber);
                }
                const canvasCenter = canvas.offsetTop + canvas.offsetHeight / 2;
                if (canvasCenter >= containerScrollTop && canvasCenter <= containerScrollTop + pdfPreviewCanvasContainer.clientHeight) {
                    currentPageInView = parseInt(canvas.dataset.pageNumber);
                    break;
                }
            }
            previewPageInfoSpan.textContent = `ç¬¬ ${currentPageInView} / ${currentPdfDocument.numPages} é¡µ`;
        }

        async function renderAllPdfPages() { /* ... (ä¿æŒä¸å˜) ... */
            if (!currentPdfDocument) return;
            pdfPreviewCanvasContainer.innerHTML = '';
            previewPageInfoSpan.textContent = `å…± ${currentPdfDocument.numPages} é¡µï¼Œæ­£åœ¨æ¸²æŸ“ 1/${currentPdfDocument.numPages}...`;
            pdfPreviewModal.classList.remove('hidden');
            const scale = 1.5;
            if (pdfPreviewScrollHandler) {
                pdfPreviewCanvasContainer.removeEventListener('scroll', pdfPreviewScrollHandler);
            }
            pdfPreviewScrollHandler = throttle(updatePreviewPageInfoOnScroll, 100);
            pdfPreviewCanvasContainer.addEventListener('scroll', pdfPreviewScrollHandler);

            for (let pageNum = 1; pageNum <= currentPdfDocument.numPages; pageNum++) {
                try {
                    const page = await currentPdfDocument.getPage(pageNum);
                    const viewport = page.getViewport({ scale: scale });
                    const canvas = document.createElement('canvas');
                    canvas.dataset.pageNumber = pageNum;
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    const canvasContext = canvas.getContext('2d');
                    const renderContext = { canvasContext: canvasContext, viewport: viewport };
                    await page.render(renderContext).promise;
                    pdfPreviewCanvasContainer.appendChild(canvas);
                    if (pageNum === currentPdfDocument.numPages) {
                         previewPageInfoSpan.textContent = `ç¬¬ 1 / ${currentPdfDocument.numPages} é¡µ (é¢„è§ˆå®Œæˆ)`;
                         updatePreviewPageInfoOnScroll();
                    } else {
                         previewPageInfoSpan.textContent = `å…± ${currentPdfDocument.numPages} é¡µï¼Œæ­£åœ¨æ¸²æŸ“ ${pageNum + 1}/${currentPdfDocument.numPages}...`;
                    }
                } catch (err) {
                    console.error("æ¸²æŸ“PDFé¡µé¢æ—¶å‡ºé”™:", pageNum, err);
                    const errorP = document.createElement('p');
                    errorP.textContent = `æ¸²æŸ“ç¬¬ ${pageNum} é¡µå¤±è´¥ã€‚`;
                    errorP.className = 'text-red-500 text-center py-2';
                    pdfPreviewCanvasContainer.appendChild(errorP);
                }
            }
            if (pdfPreviewCanvasContainer.children.length > 0 && currentPdfDocument.numPages > 0) {
                 updatePreviewPageInfoOnScroll();
            } else if (currentPdfDocument.numPages > 0) {
                 previewPageInfoSpan.textContent = `æ— æ³•æ¸²æŸ“PDF (å…± ${currentPdfDocument.numPages} é¡µ)`;
            } else {
                 previewPageInfoSpan.textContent = `æ— é¡µé¢å¯é¢„è§ˆ`;
            }
        }

        printPreviewBtn.addEventListener('click', function() {
            if (currentPdfDocument) { renderAllPdfPages(); }
            else { alert("è¯·å…ˆä¸Šä¼ ä¸€ä¸ªæœ‰æ•ˆçš„PDFæ–‡ä»¶ä»¥è¿›è¡Œé¢„è§ˆã€‚"); }
        });

        closePreviewModalBtn.addEventListener('click', function() {
            pdfPreviewModal.classList.add('hidden');
            pdfPreviewCanvasContainer.innerHTML = '';
            previewPageInfoSpan.textContent = '';
            if (pdfPreviewScrollHandler) {
                pdfPreviewCanvasContainer.removeEventListener('scroll', pdfPreviewScrollHandler);
                pdfPreviewScrollHandler = null;
            }
        });

        pdfPreviewModal.addEventListener('click', function(event) {
            if (event.target === pdfPreviewModal) { closePreviewModalBtn.click(); }
        });

        function throttle(func, limit) { /* ... (ä¿æŒä¸å˜) ... */
            let lastFunc; let lastRan;
            return function(...args) {
                const context = this;
                if (!lastRan) { func.apply(context, args); lastRan = Date.now(); }
                else { clearTimeout(lastFunc); lastFunc = setTimeout(function() {
                        if ((Date.now() - lastRan) >= limit) { func.apply(context, args); lastRan = Date.now(); }
                    }, limit - (Date.now() - lastRan));
                }
            }
        }

        function populatePaperSizes() {
            const category = paperCategorySelect.value;
            let options = '';
            coatedPaperWeightGroup.classList.add('hidden');
            if (category === 'basic') {
                options = `<option value="a4">A4</option><option value="b5">B5</option><option value="a3">A3</option><option value="a7">A7 (å°æ ‡ç­¾ç­‰)</option>`;
            } else if (category === 'colorJet') {
                options = `<option value="a4">A4</option><option value="a3">A3</option>`;
            } else if (category === 'coated') {
                options = `<option value="a4">A4 (é“œç‰ˆçº¸ä»…æ”¯æŒA4)</option>`;
                coatedPaperWeightGroup.classList.remove('hidden');
            }
            paperSizeSelect.innerHTML = options;
            if (category === 'coated') { paperSizeSelect.value = 'a4'; }
            updateAllSegmentModesForA7();
            calculatePrice();
        }

        function updateBindingNote() {
            const selectedOption = bindingTypeSelect.options[bindingTypeSelect.selectedIndex];
            const note = selectedOption.dataset.note;
            bindingNoteP.textContent = note ? `å¤‡æ³¨: ${note}` : '';
        }

        function calculatePrice() {
            const category = paperCategorySelect.value;
            const currentPaperSize = paperSizeSelect.value;
            const coatedWeight = coatedPaperWeightSelect.value;
            const quantity = parseInt(quantityInput.value) || 0;
            const binding = bindingTypeSelect.value;
            const totalDocPages = parseInt(pagesPerDocumentInput.value) || 0;

            let totalSegmentPrintCostForOneCopy = 0;
            detailedPrintCostsBody.innerHTML = '';

            if (quantity <= 0) {
                 summaryBasePrintCostEl.textContent = '0.00 å…ƒ';
                 summaryBindingCostEl.textContent = '0.00 å…ƒ';
                 minOrderAdjustmentRow.classList.add('hidden');
                 summaryShippingCostEl.textContent = '0.00 å…ƒ';
                 summaryTotalCostEl.textContent = '0.00 å…ƒ';
                 summaryBasePrintCostLabel.textContent = `æ€»æ‰“å°è´¹ç”¨ (å…± ${quantity} ä»½):`;
                 return;
            }

            for (const segment of printSegments) {
                const startPage = parseInt(segment.startPage) || 0;
                const endPage = parseInt(segment.endPage) || 0;
                let mode = segment.mode;
                let isValidSegment = true;

                const segmentElement = segmentListContainer.querySelector(`.segment-item[data-segment-id="${segment.id}"]`);
                if (segmentElement) {
                    const startInputEl = segmentElement.querySelector('.segment-start-page');
                    const endInputEl = segmentElement.querySelector('.segment-end-page');
                    startInputEl.classList.remove('invalid-segment');
                    endInputEl.classList.remove('invalid-segment');
                    if (startPage <= 0 || endPage < startPage || endPage > totalDocPages) {
                        isValidSegment = false;
                        if (startPage <= 0 || startPage > endPage) startInputEl.classList.add('invalid-segment');
                        if (endPage < startPage || endPage > totalDocPages) endInputEl.classList.add('invalid-segment');
                    }
                }
                if (!isValidSegment) continue;

                const currentEndPage = Math.min(endPage, totalDocPages);
                if (startPage > currentEndPage) continue;

                const segmentPages = currentEndPage - startPage + 1;
                let segmentCostPerPageSide = 0;
                let unitPriceDescription = "";

                let paperDisplayName = "";
                let colorDisplayName = "";

                if (category === 'basic') {
                    paperDisplayName = "æ™®é€šçº¸";
                    colorDisplayName = "é»‘ç™½";
                    if (pricing.basicPrint[currentPaperSize]) {
                        segmentCostPerPageSide = pricing.basicPrint[currentPaperSize][mode];
                    }
                } else if (category === 'colorJet') {
                    paperDisplayName = "å½©æ¿€çº¸";
                    colorDisplayName = "å½©è‰²";
                    if (pricing.colorPrintJet[currentPaperSize]) {
                        segmentCostPerPageSide = pricing.colorPrintJet[currentPaperSize][mode];
                    }
                } else if (category === 'coated') {
                    paperDisplayName = `${coatedPaperWeightSelect.options[coatedPaperWeightSelect.selectedIndex].text}é“œç‰ˆçº¸`;
                    colorDisplayName = "å½©è‰²";
                    if (pricing.colorPrintCoated[coatedWeight]) {
                        segmentCostPerPageSide = pricing.colorPrintCoated[coatedWeight][mode];
                    }
                }

                unitPriceDescription = `(å•ä»·: ${segmentCostPerPageSide.toFixed(3)} å…ƒ/é¢)`;
                const costForThisSegmentOneCopy = segmentCostPerPageSide * segmentPages;
                totalSegmentPrintCostForOneCopy += costForThisSegmentOneCopy;

                const segmentDescription = `æ‰“å°åŒºé—´ (${startPage}-${currentEndPage}é¡µ, ${currentPaperSize.toUpperCase()} ${paperDisplayName} ${colorDisplayName} ${mode === 'single' ? 'å•é¢' : 'åŒé¢'}) ${unitPriceDescription}`;

                const tr = document.createElement('tr');
                tr.className = 'detailed-cost-row';
                tr.innerHTML = `
                    <td>${segmentDescription}:</td>
                    <td class="text-right font-medium">${costForThisSegmentOneCopy.toFixed(2)} å…ƒ</td>
                `;
                detailedPrintCostsBody.appendChild(tr);
            }

            const totalRawPrintCost = totalSegmentPrintCostForOneCopy * quantity;
            summaryBasePrintCostLabel.textContent = `æ€»æ‰“å°è´¹ç”¨ (å…± ${quantity} ä»½):`;
            summaryBasePrintCostEl.textContent = `${totalRawPrintCost.toFixed(2)} å…ƒ`;

            const totalBindingCost = (pricing.binding[binding] || 0) * quantity;
            summaryBindingCostEl.textContent = `${totalBindingCost.toFixed(2)} å…ƒ`;

            let subtotalBeforeMinChargeAndBinding = totalRawPrintCost + totalBindingCost;
            let finalSubtotalForShippingAndTotal = subtotalBeforeMinChargeAndBinding;

            minOrderAdjustmentRow.classList.add('hidden');
            if (subtotalBeforeMinChargeAndBinding > 0 && subtotalBeforeMinChargeAndBinding < pricing.policies.minOrderValue) {
                finalSubtotalForShippingAndTotal = pricing.policies.minOrderValue;
                summaryMinOrderAdjustmentEl.textContent = `æœ€ä½èµ·å° ${pricing.policies.minOrderValue.toFixed(2)} å…ƒ`; // Text for the value cell
                minOrderAdjustmentRow.classList.remove('hidden');
            }

            let shippingCost = 0;
            if (finalSubtotalForShippingAndTotal > 0 && finalSubtotalForShippingAndTotal < pricing.policies.freeShippingThreshold) {
                shippingCost = pricing.policies.shippingFee;
            }
            summaryShippingCostEl.textContent = `${shippingCost.toFixed(2)} å…ƒ`;

            const finalTotal = finalSubtotalForShippingAndTotal + shippingCost;
            summaryTotalCostEl.textContent = `${finalTotal.toFixed(2)} å…ƒ`;
        }

        function generateOrderNumber() { /* ... (ä¿æŒä¸å˜) ... */
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            const randomStr = Math.random().toString(36).substring(2, 7).toUpperCase();
            return `HYY-${year}${month}${day}-${hours}${minutes}${seconds}-${randomStr}`;
        }

        function escapeCsvCell(cellData) { /* ... (ä¿æŒä¸å˜) ... */
            if (typeof cellData === 'number') {
                return cellData.toString();
            }
            if (typeof cellData === 'string') {
                if (cellData.includes(',') || cellData.includes('"') || cellData.includes('\n')) {
                    return `"${cellData.replace(/"/g, '""')}"`;
                }
                return cellData;
            }
            return '';
        }

        function exportOrderToCsv(orderDetails) {
            const headers = [
                "è®¢å•å·", "ä¸‹å•æ—¶é—´", "æ–‡ä»¶å", "æ–‡æ¡£æ€»é¡µæ•°", "æ‰“å°ä»½æ•°",
                "çº¸å¼ ç±»åˆ«", "çº¸å¼ è§„æ ¼", "é“œç‰ˆçº¸å…‹é‡",
                "æ‰“å°åŒºé—´è¯¦æƒ…",
                "è£…è®¢ç±»å‹", "æ€»æ‰“å°è´¹ç”¨(å…ƒ)", "è£…è®¢è´¹ç”¨(å…ƒ)",
                "è¿è´¹(å…ƒ)", "é¢„ä¼°æ€»ä»·(å…ƒ)"
            ];
            const row = [
                orderDetails.orderNumber, orderDetails.orderTime, orderDetails.fileName, orderDetails.docTotalPages, orderDetails.quantity,
                orderDetails.paperCategory, orderDetails.paperSize, orderDetails.coatedWeight,
                orderDetails.segmentDetails,
                orderDetails.binding,
                orderDetails.basePrintCost.replace(' å…ƒ',''), orderDetails.bindingCost.replace(' å…ƒ',''),
                orderDetails.shippingCost.replace(' å…ƒ',''), orderDetails.estimatedTotal.replace(' å…ƒ','')
            ];
            let csvContent = "\uFEFF";
            csvContent += headers.map(header => escapeCsvCell(header)).join(',') + '\r\n';
            csvContent += row.map(cell => escapeCsvCell(cell)).join(',') + '\r\n';
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `å—¨äº‘å°è®¢å•_${orderDetails.orderNumber}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }
         }

        // Event Listeners
        paperCategorySelect.addEventListener('change', () => { populatePaperSizes(); });
        paperSizeSelect.addEventListener('change', () => {
            updateAllSegmentModesForA7();
            calculatePrice();
        });
        coatedPaperWeightSelect.addEventListener('change', calculatePrice);
        quantityInput.addEventListener('input', calculatePrice);
        bindingTypeSelect.addEventListener('change', () => { updateBindingNote(); calculatePrice(); });

        submitOrderButton.addEventListener('click', () => {
            const orderNumber = generateOrderNumber();
            const now = new Date();
            const orderTime = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
            const segmentDetailsString = printSegments.map(s => {
                let segmentCostPerPageSide = 0;
                let tempMode = s.mode;
                const currentPaperSize = paperSizeSelect.value;
                const category = paperCategorySelect.value;
                const coatedWeightVal = coatedPaperWeightSelect.value;
                if (category === 'basic' && currentPaperSize === 'a7') tempMode = 'single';
                if (category === 'basic') {
                    if (pricing.basicPrint[currentPaperSize]) segmentCostPerPageSide = pricing.basicPrint[currentPaperSize][tempMode];
                } else if (category === 'colorJet') {
                    if (pricing.colorPrintJet[currentPaperSize]) segmentCostPerPageSide = pricing.colorPrintJet[currentPaperSize][tempMode];
                } else if (category === 'coated') {
                    if (pricing.colorPrintCoated[coatedWeightVal]) segmentCostPerPageSide = pricing.colorPrintCoated[coatedWeightVal][tempMode];
                }
                return `${s.startPage}-${s.endPage}(${s.mode === 'single' ? 'å•é¢' : 'åŒé¢'}, å•ä»·:${segmentCostPerPageSide.toFixed(3)})`;
            }).join('; ');

            const orderDetails = {
                orderNumber: orderNumber, orderTime: orderTime,
                fileName: fileUploadInput.files[0] ? fileUploadInput.files[0].name : "æœªä¸Šä¼ æ–‡ä»¶",
                docTotalPages: pagesPerDocumentInput.value,
                quantity: quantityInput.value,
                paperCategory: paperCategorySelect.options[paperCategorySelect.selectedIndex].text,
                paperSize: paperSizeSelect.options[paperSizeSelect.selectedIndex].text,
                coatedWeight: coatedPaperWeightGroup.classList.contains('hidden') ? 'N/A' : coatedPaperWeightSelect.value,
                segmentDetails: segmentDetailsString,
                binding: bindingTypeSelect.options[bindingTypeSelect.selectedIndex].text,
                basePrintCost: summaryBasePrintCostEl.textContent,
                bindingCost: summaryBindingCostEl.textContent,
                shippingCost: summaryShippingCostEl.textContent,
                estimatedTotal: summaryTotalCostEl.textContent,
                logoUsed: siteLogo.src
            };
            exportOrderToCsv(orderDetails);
            alert(`è®¢å•å·²ç”Ÿæˆï¼\nè®¢å•å·: ${orderNumber}\nè®¢å•è¯¦æƒ…å·²å¯¼å‡ºä¸ºCSVæ–‡ä»¶ï¼Œè¯·æŸ¥æ”¶ä¸‹è½½ã€‚\n\nè¯·é€šè¿‡å¾®ä¿¡ç§èŠå‘é€åŸå§‹æ‰“å°æ–‡ä»¶ã€å¯¼å‡ºçš„è®¢å•CSVæ–‡ä»¶å’Œæ”¶è´§ä¿¡æ¯ç­‰ä»¥æœ€ç»ˆç¡®è®¤è®¢å•ã€‚`);
        });

        document.addEventListener('DOMContentLoaded', () => {
            populatePaperSizes();
            updateBindingNote();
            addSegment();
            calculatePrice();
        });
    </script>

</body>
</html>
